Sun Dec 15 22:07:28 EET 2024
+ hostname
Vrska-Vesi
+ ansible-playbook infra.yaml --diff
[WARNING]: Invalid characters were found in group names but not replaced, use
-vvvv to see details

PLAY [Initial setup] ***********************************************************

TASK [Gathering Facts] *********************************************************
[WARNING]: Platform linux on host Kryptograafia-1 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host Kryptograafia-2 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host Kryptograafia-3 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]

TASK [init : Update APT cache] *************************************************
changed: [Kryptograafia-3]
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [init : Install fping] ****************************************************
The following NEW packages will be installed:
  fping
0 upgraded, 1 newly installed, 0 to remove and 132 not upgraded.
changed: [Kryptograafia-3]
The following NEW packages will be installed:
  fping
0 upgraded, 1 newly installed, 0 to remove and 132 not upgraded.
changed: [Kryptograafia-1]
The following NEW packages will be installed:
  fping
0 upgraded, 1 newly installed, 0 to remove and 132 not upgraded.
changed: [Kryptograafia-2]

TASK [init : Ensure pip3 is installed] *****************************************
The following additional packages will be installed:
  build-essential bzip2 cpp cpp-11 dpkg-dev fakeroot fontconfig-config
  fonts-dejavu-core g++ g++-11 gcc gcc-11 gcc-11-base javascript-common
  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
  libasan6 libatomic1 libc-dev-bin libc-devtools libc6 libc6-dev libcc1-0
  libcrypt-dev libdeflate0 libdpkg-perl libexpat1 libexpat1-dev libfakeroot
  libfile-fcntllock-perl libfontconfig1 libgcc-11-dev libgd3 libgomp1 libisl23
  libitm1 libjbig0 libjpeg-turbo8 libjpeg8 libjs-jquery libjs-sphinxdoc
  libjs-underscore liblsan0 libmpc3 libnsl-dev libpython3-dev
  libpython3-stdlib libpython3.10 libpython3.10-dev libpython3.10-minimal
  libpython3.10-stdlib libquadmath0 libstdc++-11-dev libtiff5 libtirpc-dev
  libtsan0 libubsan1 libwebp7 libxpm4 linux-libc-dev lto-disabled-list make
  manpages-dev python3 python3-dev python3-minimal python3-wheel python3.10
  python3.10-dev python3.10-minimal rpcsvc-proto zlib1g-dev
Suggested packages:
  bzip2-doc cpp-doc gcc-11-locales debian-keyring g++-multilib g++-11-multilib
  gcc-11-doc gcc-multilib autoconf automake libtool flex bison gdb gcc-doc
  gcc-11-multilib apache2 | lighttpd | httpd glibc-doc bzr libgd-tools
  libstdc++-11-doc make-doc python3-doc python3-tk python3-venv
  python3.10-venv python3.10-doc binfmt-support
Recommended packages:
  libnss-nis libnss-nisplus
The following NEW packages will be installed:
  build-essential bzip2 cpp cpp-11 dpkg-dev fakeroot fontconfig-config
  fonts-dejavu-core g++ g++-11 gcc gcc-11 gcc-11-base javascript-common
  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
  libasan6 libatomic1 libc-dev-bin libc-devtools libc6-dev libcc1-0
  libcrypt-dev libdeflate0 libdpkg-perl libexpat1-dev libfakeroot
  libfile-fcntllock-perl libfontconfig1 libgcc-11-dev libgd3 libgomp1 libisl23
  libitm1 libjbig0 libjpeg-turbo8 libjpeg8 libjs-jquery libjs-sphinxdoc
  libjs-underscore liblsan0 libmpc3 libnsl-dev libpython3-dev
  libpython3.10-dev libquadmath0 libstdc++-11-dev libtiff5 libtirpc-dev
  libtsan0 libubsan1 libwebp7 libxpm4 linux-libc-dev lto-disabled-list make
  manpages-dev python3-dev python3-pip python3-wheel python3.10-dev
  rpcsvc-proto zlib1g-dev
The following packages will be upgraded:
  libc6 libexpat1 libpython3-stdlib libpython3.10 libpython3.10-minimal
  libpython3.10-stdlib python3 python3-minimal python3.10 python3.10-minimal
10 upgraded, 64 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  build-essential bzip2 cpp cpp-11 dpkg-dev fakeroot fontconfig-config
  fonts-dejavu-core g++ g++-11 gcc gcc-11 gcc-11-base javascript-common
  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
  libasan6 libatomic1 libc-dev-bin libc-devtools libc6 libc6-dev libcc1-0
  libcrypt-dev libdeflate0 libdpkg-perl libexpat1 libexpat1-dev libfakeroot
  libfile-fcntllock-perl libfontconfig1 libgcc-11-dev libgd3 libgomp1 libisl23
  libitm1 libjbig0 libjpeg-turbo8 libjpeg8 libjs-jquery libjs-sphinxdoc
  libjs-underscore liblsan0 libmpc3 libnsl-dev libpython3-dev
  libpython3-stdlib libpython3.10 libpython3.10-dev libpython3.10-minimal
  libpython3.10-stdlib libquadmath0 libstdc++-11-dev libtiff5 libtirpc-dev
  libtsan0 libubsan1 libwebp7 libxpm4 linux-libc-dev lto-disabled-list make
  manpages-dev python3 python3-dev python3-minimal python3-wheel python3.10
  python3.10-dev python3.10-minimal rpcsvc-proto zlib1g-dev
Suggested packages:
  bzip2-doc cpp-doc gcc-11-locales debian-keyring g++-multilib g++-11-multilib
  gcc-11-doc gcc-multilib autoconf automake libtool flex bison gdb gcc-doc
  gcc-11-multilib apache2 | lighttpd | httpd glibc-doc bzr libgd-tools
  libstdc++-11-doc make-doc python3-doc python3-tk python3-venv
  python3.10-venv python3.10-doc binfmt-support
Recommended packages:
  libnss-nis libnss-nisplus
The following NEW packages will be installed:
  build-essential bzip2 cpp cpp-11 dpkg-dev fakeroot fontconfig-config
  fonts-dejavu-core g++ g++-11 gcc gcc-11 gcc-11-base javascript-common
  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
  libasan6 libatomic1 libc-dev-bin libc-devtools libc6-dev libcc1-0
  libcrypt-dev libdeflate0 libdpkg-perl libexpat1-dev libfakeroot
  libfile-fcntllock-perl libfontconfig1 libgcc-11-dev libgd3 libgomp1 libisl23
  libitm1 libjbig0 libjpeg-turbo8 libjpeg8 libjs-jquery libjs-sphinxdoc
  libjs-underscore liblsan0 libmpc3 libnsl-dev libpython3-dev
  libpython3.10-dev libquadmath0 libstdc++-11-dev libtiff5 libtirpc-dev
  libtsan0 libubsan1 libwebp7 libxpm4 linux-libc-dev lto-disabled-list make
  manpages-dev python3-dev python3-pip python3-wheel python3.10-dev
  rpcsvc-proto zlib1g-dev
The following packages will be upgraded:
  libc6 libexpat1 libpython3-stdlib libpython3.10 libpython3.10-minimal
  libpython3.10-stdlib python3 python3-minimal python3.10 python3.10-minimal
10 upgraded, 64 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-1]
The following additional packages will be installed:
  build-essential bzip2 cpp cpp-11 dpkg-dev fakeroot fontconfig-config
  fonts-dejavu-core g++ g++-11 gcc gcc-11 gcc-11-base javascript-common
  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
  libasan6 libatomic1 libc-dev-bin libc-devtools libc6 libc6-dev libcc1-0
  libcrypt-dev libdeflate0 libdpkg-perl libexpat1 libexpat1-dev libfakeroot
  libfile-fcntllock-perl libfontconfig1 libgcc-11-dev libgd3 libgomp1 libisl23
  libitm1 libjbig0 libjpeg-turbo8 libjpeg8 libjs-jquery libjs-sphinxdoc
  libjs-underscore liblsan0 libmpc3 libnsl-dev libpython3-dev
  libpython3-stdlib libpython3.10 libpython3.10-dev libpython3.10-minimal
  libpython3.10-stdlib libquadmath0 libstdc++-11-dev libtiff5 libtirpc-dev
  libtsan0 libubsan1 libwebp7 libxpm4 linux-libc-dev lto-disabled-list make
  manpages-dev python3 python3-dev python3-minimal python3-wheel python3.10
  python3.10-dev python3.10-minimal rpcsvc-proto zlib1g-dev
Suggested packages:
  bzip2-doc cpp-doc gcc-11-locales debian-keyring g++-multilib g++-11-multilib
  gcc-11-doc gcc-multilib autoconf automake libtool flex bison gdb gcc-doc
  gcc-11-multilib apache2 | lighttpd | httpd glibc-doc bzr libgd-tools
  libstdc++-11-doc make-doc python3-doc python3-tk python3-venv
  python3.10-venv python3.10-doc binfmt-support
Recommended packages:
  libnss-nis libnss-nisplus
The following NEW packages will be installed:
  build-essential bzip2 cpp cpp-11 dpkg-dev fakeroot fontconfig-config
  fonts-dejavu-core g++ g++-11 gcc gcc-11 gcc-11-base javascript-common
  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
  libasan6 libatomic1 libc-dev-bin libc-devtools libc6-dev libcc1-0
  libcrypt-dev libdeflate0 libdpkg-perl libexpat1-dev libfakeroot
  libfile-fcntllock-perl libfontconfig1 libgcc-11-dev libgd3 libgomp1 libisl23
  libitm1 libjbig0 libjpeg-turbo8 libjpeg8 libjs-jquery libjs-sphinxdoc
  libjs-underscore liblsan0 libmpc3 libnsl-dev libpython3-dev
  libpython3.10-dev libquadmath0 libstdc++-11-dev libtiff5 libtirpc-dev
  libtsan0 libubsan1 libwebp7 libxpm4 linux-libc-dev lto-disabled-list make
  manpages-dev python3-dev python3-pip python3-wheel python3.10-dev
  rpcsvc-proto zlib1g-dev
The following packages will be upgraded:
  libc6 libexpat1 libpython3-stdlib libpython3.10 libpython3.10-minimal
  libpython3.10-stdlib python3 python3-minimal python3.10 python3.10-minimal
10 upgraded, 64 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-3]

TASK [init : Ensure dnspython library is installed on the managed host] ********
changed: [Kryptograafia-2]
changed: [Kryptograafia-3]
changed: [Kryptograafia-1]

TASK [init : Install Prometheus node exporter on all VM-s] *********************
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-3]
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-1]

TASK [init : Configure rsyslog.conf file] **************************************
--- before: /etc/rsyslog.conf
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpzn6kisot/rsyslog.conf.j2
@@ -15,7 +15,7 @@
 
 # provides UDP syslog reception
 #module(load="imudp")
-#input(type="imudp" port="514")
+#input(type="imudp" port="6514")
 
 # provides TCP syslog reception
 #module(load="imtcp")

changed: [Kryptograafia-1]
--- before: /etc/rsyslog.conf
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpvjvo4_ro/rsyslog.conf.j2
@@ -15,7 +15,7 @@
 
 # provides UDP syslog reception
 #module(load="imudp")
-#input(type="imudp" port="514")
+#input(type="imudp" port="6514")
 
 # provides TCP syslog reception
 #module(load="imtcp")

changed: [Kryptograafia-2]
--- before: /etc/rsyslog.conf
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmp45p0for_/rsyslog.conf.j2
@@ -15,7 +15,7 @@
 
 # provides UDP syslog reception
 #module(load="imudp")
-#input(type="imudp" port="514")
+#input(type="imudp" port="6514")
 
 # provides TCP syslog reception
 #module(load="imtcp")

changed: [Kryptograafia-3]

TASK [init : Configure rsyslog to send logs to Telegraf] ***********************
--- before
+++ after: /home/ronk/ica0002/roles/init/files/50-telegraf.conf
@@ -0,0 +1,8 @@
+$ActionQueueType LinkedList # use asynchronous processing
+$ActionQueueFileName srvrfwd # set file name, also enables disk mode
+$ActionResumeRetryCount -1 # infinite retries on insert failure
+$ActionQueueSaveOnShutdown on # save in-memory data if rsyslog shuts down
+
+
+# uncomment to use udp according to RFC 5424
+*.* @influxdb:6514;RSYSLOG_SyslogProtocol23Format

changed: [Kryptograafia-2]
--- before
+++ after: /home/ronk/ica0002/roles/init/files/50-telegraf.conf
@@ -0,0 +1,8 @@
+$ActionQueueType LinkedList # use asynchronous processing
+$ActionQueueFileName srvrfwd # set file name, also enables disk mode
+$ActionResumeRetryCount -1 # infinite retries on insert failure
+$ActionQueueSaveOnShutdown on # save in-memory data if rsyslog shuts down
+
+
+# uncomment to use udp according to RFC 5424
+*.* @influxdb:6514;RSYSLOG_SyslogProtocol23Format

changed: [Kryptograafia-3]
--- before
+++ after: /home/ronk/ica0002/roles/init/files/50-telegraf.conf
@@ -0,0 +1,8 @@
+$ActionQueueType LinkedList # use asynchronous processing
+$ActionQueueFileName srvrfwd # set file name, also enables disk mode
+$ActionResumeRetryCount -1 # infinite retries on insert failure
+$ActionQueueSaveOnShutdown on # save in-memory data if rsyslog shuts down
+
+
+# uncomment to use udp according to RFC 5424
+*.* @influxdb:6514;RSYSLOG_SyslogProtocol23Format

changed: [Kryptograafia-1]

TASK [init : Ensure the backup user exists] ************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-3]
changed: [Kryptograafia-2]

TASK [init : Add backup server SSH key to known_hosts for user backup] *********
changed: [Kryptograafia-1]
changed: [Kryptograafia-3]
changed: [Kryptograafia-2]

TASK [init : Ensure /home/backup/restore directory exists] *********************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-3]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-2]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-1]

TASK [init : Install Duplicity backup software] ********************************
The following additional packages will be installed:
  librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient par2
  python-future-doc python-lockfile-doc python-nacl-doc python3-gssapi
  python3-invoke
The following NEW packages will be installed:
  duplicity librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-1]
The following additional packages will be installed:
  librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient par2
  python-future-doc python-lockfile-doc python-nacl-doc python3-gssapi
  python3-invoke
The following NEW packages will be installed:
  duplicity librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient par2
  python-future-doc python-lockfile-doc python-nacl-doc python3-gssapi
  python3-invoke
The following NEW packages will be installed:
  duplicity librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 122 not upgraded.
changed: [Kryptograafia-3]

RUNNING HANDLER [init : Restart rsyslog] ***************************************
changed: [Kryptograafia-2]
changed: [Kryptograafia-3]
changed: [Kryptograafia-1]

PLAY [Bind9 server] ************************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [bind : Install Bind9 service] ********************************************
The following additional packages will be installed:
  bind9-dnsutils bind9-host bind9-libs bind9-utils dns-root-data
Suggested packages:
  bind-doc resolvconf
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data
The following packages will be upgraded:
  bind9-dnsutils bind9-host bind9-libs
3 upgraded, 3 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  bind9-dnsutils bind9-host bind9-libs bind9-utils dns-root-data
Suggested packages:
  bind-doc resolvconf
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data
The following packages will be upgraded:
  bind9-dnsutils bind9-host bind9-libs
3 upgraded, 3 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]
The following additional packages will be installed:
  bind9-dnsutils bind9-host bind9-libs bind9-utils dns-root-data
Suggested packages:
  bind-doc resolvconf
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data
The following packages will be upgraded:
  bind9-dnsutils bind9-host bind9-libs
3 upgraded, 3 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-3]

TASK [bind : Copy the bind DNS named and local configuration to VM2] ***********
changed: [Kryptograafia-3] => (item=None)
changed: [Kryptograafia-1] => (item=None)
changed: [Kryptograafia-2] => (item=None)
changed: [Kryptograafia-3] => (item=None)
changed: [Kryptograafia-3]
changed: [Kryptograafia-2] => (item=None)
changed: [Kryptograafia-2]
changed: [Kryptograafia-1] => (item=None)
changed: [Kryptograafia-1]

TASK [bind : Create master zone file and copy it to VM3] ***********************
skipping: [Kryptograafia-1]
skipping: [Kryptograafia-2]
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpx3hcj0wl/db.kryptograafia.io.j2
@@ -0,0 +1,16 @@
+$TTL 604800
+kryptograafia.io. IN  SOA Kryptograafia-3.kryptograafia.io. Kryptograafia.kryptograafia.io. (
+            3 ; Serial
+       604800 ; Refresh
+        86400 ; Retry
+      2419200 ; Expire
+       604800 ; Negative Cache TTL
+)
+
+kryptograafia.io. IN NS Kryptograafia-3.kryptograafia.io.
+kryptograafia.io. IN NS Kryptograafia-1.kryptograafia.io.
+kryptograafia.io. IN NS Kryptograafia-2.kryptograafia.io.
+Kryptograafia-1   IN  A   192.168.42.23
+Kryptograafia-2   IN  A   192.168.42.125
+Kryptograafia-3   IN  A   192.168.42.141
+

changed: [Kryptograafia-3]

TASK [bind : Create reverse zone file and copy it to VM2] **********************
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpe1fasego/db.rev.j2
@@ -0,0 +1,15 @@
+$TTL 604800
+168.192.in-addr.arpa. IN SOA Kryptograafia-3.kryptograafia.io. Kryptograafia.kryptograafia.io. (
+          2 ; Serial
+     604800 ; Refresh
+      86400 ; Retry
+    2419200 ; Expire
+     604800 ; Negative Cache TTL
+);
+
+168.192.in-addr.arpa. IN NS Kryptograafia-3.kryptograafia.io.;
+168.192.in-addr.arpa. IN NS Kryptograafia-1.kryptograafia.io.;
+168.192.in-addr.arpa. IN NS Kryptograafia-2.kryptograafia.io.;
+23.42 IN PTR Kryptograafia-1.kryptograafia.io.;
+125.42 IN PTR Kryptograafia-2.kryptograafia.io.;
+141.42 IN PTR Kryptograafia-3.kryptograafia.io.;

changed: [Kryptograafia-3]
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpxlmrwmzg/db.rev.j2
@@ -0,0 +1,15 @@
+$TTL 604800
+168.192.in-addr.arpa. IN SOA Kryptograafia-3.kryptograafia.io. Kryptograafia.kryptograafia.io. (
+          2 ; Serial
+     604800 ; Refresh
+      86400 ; Retry
+    2419200 ; Expire
+     604800 ; Negative Cache TTL
+);
+
+168.192.in-addr.arpa. IN NS Kryptograafia-3.kryptograafia.io.;
+168.192.in-addr.arpa. IN NS Kryptograafia-1.kryptograafia.io.;
+168.192.in-addr.arpa. IN NS Kryptograafia-2.kryptograafia.io.;
+23.42 IN PTR Kryptograafia-1.kryptograafia.io.;
+125.42 IN PTR Kryptograafia-2.kryptograafia.io.;
+141.42 IN PTR Kryptograafia-3.kryptograafia.io.;

changed: [Kryptograafia-1]
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpqtsoqoni/db.rev.j2
@@ -0,0 +1,15 @@
+$TTL 604800
+168.192.in-addr.arpa. IN SOA Kryptograafia-3.kryptograafia.io. Kryptograafia.kryptograafia.io. (
+          2 ; Serial
+     604800 ; Refresh
+      86400 ; Retry
+    2419200 ; Expire
+     604800 ; Negative Cache TTL
+);
+
+168.192.in-addr.arpa. IN NS Kryptograafia-3.kryptograafia.io.;
+168.192.in-addr.arpa. IN NS Kryptograafia-1.kryptograafia.io.;
+168.192.in-addr.arpa. IN NS Kryptograafia-2.kryptograafia.io.;
+23.42 IN PTR Kryptograafia-1.kryptograafia.io.;
+125.42 IN PTR Kryptograafia-2.kryptograafia.io.;
+141.42 IN PTR Kryptograafia-3.kryptograafia.io.;

changed: [Kryptograafia-2]

TASK [bind : Ensure Bind9 is started and enabled] ******************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : Download Bind9 exporter] ******************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]
changed: [Kryptograafia-3]

TASK [bind : Install Bind9 exporter] *******************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-3]
changed: [Kryptograafia-2]

TASK [bind : Copy the system definition to /etc/systemd/system/] ***************
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmp355yapln/service_def.j2
@@ -0,0 +1,10 @@
+[Unit]
+Description=Prometheus Bind9 Exporter
+
+[Service]
+Restart=on_failure
+User=prometheus
+ExecStart=/usr/local/bin/bind_exporter
+
+[Install]
+WantedBy=multi-user.target

changed: [Kryptograafia-3]
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmply76jvf_/service_def.j2
@@ -0,0 +1,10 @@
+[Unit]
+Description=Prometheus Bind9 Exporter
+
+[Service]
+Restart=on_failure
+User=prometheus
+ExecStart=/usr/local/bin/bind_exporter
+
+[Install]
+WantedBy=multi-user.target

changed: [Kryptograafia-1]
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpho7i6216/service_def.j2
@@ -0,0 +1,10 @@
+[Unit]
+Description=Prometheus Bind9 Exporter
+
+[Service]
+Restart=on_failure
+User=prometheus
+ExecStart=/usr/local/bin/bind_exporter
+
+[Install]
+WantedBy=multi-user.target

changed: [Kryptograafia-2]

TASK [bind : Start and enable Bind9 exporter service] **************************
changed: [Kryptograafia-3]
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [bind : meta] *************************************************************

TASK [bind : meta] *************************************************************

TASK [bind : meta] *************************************************************

RUNNING HANDLER [bind : Restart bind if there is a configuration change] *******
changed: [Kryptograafia-2]
changed: [Kryptograafia-3]
changed: [Kryptograafia-1]

RUNNING HANDLER [bind : rndc sync] *********************************************
changed: [Kryptograafia-3]
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

RUNNING HANDLER [bind : Reload systemd to apply changes] ***********************
changed: [Kryptograafia-3]
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [bind : Add A record for backup server] ***********************************
changed: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3, Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for ns-3 server] ***************************
changed: [Kryptograafia-3]
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [bind : Stop and disable systemd-resolved service] ************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-3]
changed: [Kryptograafia-2]

TASK [bind : Update the resolv file] *******************************************
--- before: /etc/resolv.conf
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmp5qfk4zx3/resolv.conf.j2
@@ -1,23 +1,3 @@
-# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
-# Do not edit.
-#
-# This file might be symlinked as /etc/resolv.conf. If you're looking at
-# /etc/resolv.conf and seeing this text, you have followed the symlink.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs should typically not access this file directly, but only
-# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
-# different way, replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+search kryptograafia.io
+nameserver 192.168.42.23
+nameserver 192.168.42.125

changed: [Kryptograafia-3 -> Kryptograafia-1(193.40.156.67)] => (item=Kryptograafia-1)
--- before: /etc/resolv.conf
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpl7f3mt4u/resolv.conf.j2
@@ -1,23 +1,3 @@
-# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
-# Do not edit.
-#
-# This file might be symlinked as /etc/resolv.conf. If you're looking at
-# /etc/resolv.conf and seeing this text, you have followed the symlink.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs should typically not access this file directly, but only
-# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
-# different way, replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+search kryptograafia.io
+nameserver 192.168.42.23
+nameserver 192.168.42.125

changed: [Kryptograafia-3 -> Kryptograafia-2(193.40.156.67)] => (item=Kryptograafia-2)
--- before: /etc/resolv.conf
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmp7z49k48g/resolv.conf.j2
@@ -1,23 +1,3 @@
-# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
-# Do not edit.
-#
-# This file might be symlinked as /etc/resolv.conf. If you're looking at
-# /etc/resolv.conf and seeing this text, you have followed the symlink.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs should typically not access this file directly, but only
-# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
-# different way, replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+search kryptograafia.io
+nameserver 192.168.42.23
+nameserver 192.168.42.125

changed: [Kryptograafia-3] => (item=Kryptograafia-3)

RUNNING HANDLER [bind : Restart bind if there is a configuration change] *******
changed: [Kryptograafia-3]

PLAY [Database server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Install Python MySQL client] *************************************
Suggested packages:
  python-pymysql-doc
The following NEW packages will be installed:
  python3-pymysql
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
Suggested packages:
  python-pymysql-doc
The following NEW packages will be installed:
  python3-pymysql
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]

TASK [mysql : Install MySQL server] ********************************************
The following additional packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server-8.0 mysql-server-core-8.0
Suggested packages:
  libdata-dump-perl libipc-sharedcache-perl libbusiness-isbn-perl libwww-perl
  mailx tinyca
The following NEW packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server mysql-server-8.0 mysql-server-core-8.0
0 upgraded, 27 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server-8.0 mysql-server-core-8.0
Suggested packages:
  libdata-dump-perl libipc-sharedcache-perl libbusiness-isbn-perl libwww-perl
  mailx tinyca
The following NEW packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server mysql-server-8.0 mysql-server-core-8.0
0 upgraded, 27 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]

TASK [mysql : Ensure MySQL is started and enabled] *****************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Copy the override.cnf file to managed host] **********************
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpxywot1ah/override.conf.j2
@@ -0,0 +1,6 @@
+[mysqld]
+bind-address = *
+log-bin = /var/log/mysql/mysql-bin.log
+relay-log = /var/log/mysql/mysql-relay.log
+replicate-do-db = agama
+server-id = 23

changed: [Kryptograafia-1]
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmppw0t7ele/override.conf.j2
@@ -0,0 +1,6 @@
+[mysqld]
+bind-address = *
+log-bin = /var/log/mysql/mysql-bin.log
+relay-log = /var/log/mysql/mysql-relay.log
+replicate-do-db = agama
+server-id = 125

changed: [Kryptograafia-2]

TASK [mysql : MySQL database] **************************************************
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [mysql : MySQL user] ******************************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [mysql : Ensure MySQL is started and enabled] *****************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Create MySQL user for replication] *******************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [mysql : Create user for MySQL exporter] **********************************
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [mysql : Copy my.cnf to remote host] **************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/mysql/",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-1]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/mysql/",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-2]

TASK [mysql : Ensure backup user] **********************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [mysql : Ensure MySQL client configuration for backup user is set up] *****
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpwpq9t0b7/.my.cnf-backup.j2
@@ -0,0 +1,10 @@
+[client]
+user=backup
+password=Malabinselleeksami2002#
+socket = /var/run/mysqld/mysqld.sock
+
+[mysqld]
+performance_schema=ON
+
+[mysqldump]
+no_tablespaces

changed: [Kryptograafia-1]
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpngdycjq7/.my.cnf-backup.j2
@@ -0,0 +1,10 @@
+[client]
+user=backup
+password=Malabinselleeksami2002#
+socket = /var/run/mysqld/mysqld.sock
+
+[mysqld]
+performance_schema=ON
+
+[mysqldump]
+no_tablespaces

changed: [Kryptograafia-2]

TASK [mysql : Create cron job for MySQL backup] ********************************
--- before: /etc/cron.d/mysql-backup
+++ after: /etc/cron.d/mysql-backup
@@ -0,0 +1,2 @@
+#Ansible: MySQL backup
+45 21 * * * backup mysqldump agama > /home/backup/mysql/agama.sql

changed: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Add Duplicity full backup job] ***********************************
ok: [Kryptograafia-1]
--- before: /etc/cron.d/mysql-backup (content)
+++ after: /etc/cron.d/mysql-backup (content)
@@ -1,2 +1,3 @@
 #Ansible: MySQL backup
 45 21 * * * backup mysqldump agama > /home/backup/mysql/agama.sql
+0 22 * * 0 backup duplicity --no-encryption full /home/backup/mysql/ rsync://Kryptograafia@backup.kryptograafia.io/mysql

changed: [Kryptograafia-2]

TASK [mysql : Add Duplicity incremental backup job] ****************************
ok: [Kryptograafia-1]
--- before: /etc/cron.d/mysql-backup (content)
+++ after: /etc/cron.d/mysql-backup (content)
@@ -1,3 +1,4 @@
 #Ansible: MySQL backup
 45 21 * * * backup mysqldump agama > /home/backup/mysql/agama.sql
 0 22 * * 0 backup duplicity --no-encryption full /home/backup/mysql/ rsync://Kryptograafia@backup.kryptograafia.io/mysql
+0 22 * * 1-6 backup duplicity --no-encryption incremental /home/backup/mysql/ rsync://Kryptograafia@backup.kryptograafia.io/mysql

changed: [Kryptograafia-2]

TASK [mysql : Install the MySQL exporter] **************************************
The following NEW packages will be installed:
  prometheus-mysqld-exporter
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]
The following NEW packages will be installed:
  prometheus-mysqld-exporter
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]

TASK [mysql : Ensure MySQL Exporter is started and enabled] ********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Configure the replica server] ************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for db-1 server] ***************************
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

RUNNING HANDLER [mysql : Restart MySQL if there is a configuration change] *****
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

RUNNING HANDLER [mysql : Restart MySQL exporter if authentication data changes] ***
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

RUNNING HANDLER [mysql : Reset MySQL source] ***********************************
skipping: [Kryptograafia-2] => (item=stopreplica) 
skipping: [Kryptograafia-2] => (item=resetprimary) 
skipping: [Kryptograafia-2]
changed: [Kryptograafia-1] => (item=stopreplica)
changed: [Kryptograafia-1] => (item=resetprimary)

RUNNING HANDLER [mysql : Reset MySQL replica] **********************************
skipping: [Kryptograafia-1] => (item={'mode': 'stopreplica'}) 
skipping: [Kryptograafia-1] => (item={'mode': 'changeprimary'}) 
skipping: [Kryptograafia-1] => (item={'mode': 'resetreplica'}) 
skipping: [Kryptograafia-1] => (item={'mode': 'startreplica'}) 
skipping: [Kryptograafia-1]
changed: [Kryptograafia-2] => (item={'mode': 'stopreplica'})
changed: [Kryptograafia-2] => (item={'mode': 'changeprimary'})
changed: [Kryptograafia-2] => (item={'mode': 'resetreplica'})
changed: [Kryptograafia-2] => (item={'mode': 'startreplica'})

PLAY [Docker server] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [docker : Install Docker.io] **********************************************
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io pigz runc ubuntu-fan
0 upgraded, 7 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-3]
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io pigz runc ubuntu-fan
0 upgraded, 7 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io pigz runc ubuntu-fan
0 upgraded, 7 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]

TASK [docker : Install Python Docker library] **********************************
The following additional packages will be installed:
  python3-websocket
The following NEW packages will be installed:
  python3-docker python3-websocket
0 upgraded, 2 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-3]
The following additional packages will be installed:
  python3-websocket
The following NEW packages will be installed:
  python3-docker python3-websocket
0 upgraded, 2 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  python3-websocket
The following NEW packages will be installed:
  python3-docker python3-websocket
0 upgraded, 2 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]

TASK [docker : Ensure Docker daemon is running] ********************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

PLAY [Agama servers] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [agama : Register the number of all containers] ***************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [agama : Delete containers not in use] ************************************
skipping: [Kryptograafia-1]
skipping: [Kryptograafia-2]

TASK [agama : Create /opt/agama directory] *************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/agama",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-2]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/agama",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-1]

TASK [agama : Download Agama and Dockerfile] ***********************************
changed: [Kryptograafia-1] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/agama.py)
changed: [Kryptograafia-2] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/agama.py)
changed: [Kryptograafia-1] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile)
changed: [Kryptograafia-2] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile)

TASK [agama : Build Agama Docker image] ****************************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [agama : Run Agama containers] ********************************************
changed: [Kryptograafia-1] => (item=None)
changed: [Kryptograafia-2] => (item=None)
changed: [Kryptograafia-1] => (item=None)
changed: [Kryptograafia-1]
changed: [Kryptograafia-2] => (item=None)
changed: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for www-1 server] **************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

PLAY [agama-client servers] ****************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [agama_client : Copy agama-client] ****************************************
--- before
+++ after: /home/ronk/ica0002/roles/agama_client/files/agama-client
@@ -0,0 +1,67 @@
+#!/bin/bash -eu
+
+# Please help Dora to find problems in this script
+
+for t in database_url database_name subnet; do
+    if ! grep -q "^${t}=" /etc/agama-client/agama-client.conf; then
+        logger "$0 Failed to get $t from config"
+        exit 1
+    fi
+done
+
+which fping > /dev/null || { logger "$0 fping not found"; exit 1; }
+
+logger "Starting agama-client..."
+
+db_url=$(grep "^database_url=" /etc/agama-client/agama-client.conf | sed 's/^.*=//')
+db_name=$(grep "^database_name=" /etc/agama-client/agama-client.conf | sed 's/^.*=//')
+subnet=$(grep "^subnet=" /etc/agama-client/agama-client.conf | sed 's/^.*=//')
+
+if $(curl -s "$db_url/ping"); then
+    logger "Will push data to $db_url"
+else
+    logger "Failed to connect to $db_url"
+    exit 1
+fi
+
+logger "Creating database $db_name in $db_url"
+curl -i -XPOST "$db_url/query" --data-urlencode "q=CREATE DATABASE $db_name" 1>/dev/null 2>/dev/null || { logger "$0 Failed to create database"; exit 1; }
+
+while true; do
+    alive_hosts=$(fping -g $subnet -a 2>/dev/null || true)
+    logger "Discovered $(echo "$alive_hosts" | wc -l) IPs"
+    for vm_ip in $alive_hosts; do
+        # Getting content of agama page
+        content=$(curl --connect-timeout 1 -w "%{http_code}" -s $vm_ip || continue)
+        if test ${content: -3} -ne 200; then
+            # nothing to do, going to next student
+            continue
+        fi
+        # Getting where it's hosted
+        vm_name=$(echo "$content" | grep "running on" | awk '{print $5}')
+        if [ -z $vm_name ]; then
+            # No agama running, skipping
+            continue
+        fi
+        ptr=$(host -W1 $vm_ip $vm_ip | awk '/domain name pointer/ {print $5}')
+        if ! [ -z "$ptr" ]; then
+            logger "Resolved $vm_ip to $ptr"
+            vm_name="$ptr"
+        fi
+        # Number of items in agama
+        table_rows=$(echo "$content" | grep -c "</tr>")
+        # Write stats to inflixdb
+        curl -i -XPOST "${db_url}/write?db=$db_name" --data-binary "agama-stats,name=$vm_name items=$table_rows" 1>/dev/null 2>/dev/null
+        # If hostname exists in agama - delete it
+        if $(echo "$content" | grep -q $(hostname)); then
+            for delete_url in $(echo "$content" | grep $(hostname) | grep -o '/items/.*/swap-state' | sed 's/swap-state/delete/'); do
+                curl -s $vm_ip$delete_url -o /dev/null || logger "Failed to delete $(hostname) from $vm_ip"
+            done
+        fi
+        # Add new item to agama
+        curl -s -XPOST $vm_ip/items/add -F new_item="Checked from $(hostname) at $(date)" -o /dev/null || logger "Failed to update Agama on $vm_ip"
+        logger "Posted check message to $vm_ip"
+    done
+    logger "Waiting for the next cycle to start..."
+    sleep 300
+done

changed: [Kryptograafia-3]

TASK [agama_client : Copy agama-client.service] ********************************
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpeu9d1_2o/agama-client.service.j2
@@ -0,0 +1,16 @@
+[Unit]
+Description=Agama Client Service
+Documentation=https://github.com/romankuchin/ica0002-2024/tree/main/08-logging
+After=network-online.target
+Wants=network-online.target
+
+[Service]
+Type=simple
+User=agama-client
+ExecStart=/usr/local/bin/agama-client
+Restart=always
+RestartSec=5
+StartLimitInterval=0
+
+[Install]
+WantedBy=multi-user.target

changed: [Kryptograafia-3]

TASK [agama_client : Create agama-client user] *********************************
changed: [Kryptograafia-3]

TASK [agama_client : Create directory for agama-client configuration] **********
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/etc/agama-client",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-3]

TASK [agama_client : Copy agama-client.conf] ***********************************
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmp9x4yxmgh/agama-client.conf.j2
@@ -0,0 +1,3 @@
+database_url=http://localhost:8086
+database_name=agama_client_db
+subnet=192.168.42.0/23

changed: [Kryptograafia-3]

TASK [agama_client : Ensure agama-client.service is started and enabled] *******
changed: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for aclient server] ************************
changed: [Kryptograafia-3]

RUNNING HANDLER [agama_client : Reload systemd manager configuration] **********
changed: [Kryptograafia-3]

RUNNING HANDLER [agama_client : Restart agama-client.service if there are changes in config] ***
changed: [Kryptograafia-3]

PLAY [HAProxy servers] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Install HAProxy] ***********************************************
The following additional packages will be installed:
  liblua5.3-0
Suggested packages:
  vim-haproxy haproxy-doc
The following NEW packages will be installed:
  haproxy liblua5.3-0
0 upgraded, 2 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  liblua5.3-0
Suggested packages:
  vim-haproxy haproxy-doc
The following NEW packages will be installed:
  haproxy liblua5.3-0
0 upgraded, 2 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]

TASK [haproxy : Configure HAProxy] *********************************************
--- before: /etc/haproxy/haproxy.cfg
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpw006j_x7/haproxy.cfg.j2
@@ -1,34 +1,52 @@
 global
-	log /dev/log	local0
-	log /dev/log	local1 notice
-	chroot /var/lib/haproxy
-	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
-	stats timeout 30s
-	user haproxy
-	group haproxy
-	daemon
+        log /dev/log    local0
+        log /dev/log    local1 notice
+        chroot /var/lib/haproxy
+        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
+        stats timeout 30s
+        user haproxy
+        group haproxy
+        daemon
 
-	# Default SSL material locations
-	ca-base /etc/ssl/certs
-	crt-base /etc/ssl/private
+        # Default SSL material locations
+        #ca-base /etc/ssl/certs
+        #crt-base /etc/ssl/private
 
-	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
-        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
-        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
-        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
+        # See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
+        #ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
+        #ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
+        #ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
 
 defaults
-	log	global
-	mode	http
-	option	httplog
-	option	dontlognull
+        log     global
+        mode    http
+        option  httplog
+        option  dontlognull
         timeout connect 5000
         timeout client  50000
         timeout server  50000
-	errorfile 400 /etc/haproxy/errors/400.http
-	errorfile 403 /etc/haproxy/errors/403.http
-	errorfile 408 /etc/haproxy/errors/408.http
-	errorfile 500 /etc/haproxy/errors/500.http
-	errorfile 502 /etc/haproxy/errors/502.http
-	errorfile 503 /etc/haproxy/errors/503.http
-	errorfile 504 /etc/haproxy/errors/504.http
+        errorfile 400 /etc/haproxy/errors/400.http
+        errorfile 403 /etc/haproxy/errors/403.http
+        errorfile 408 /etc/haproxy/errors/408.http
+        errorfile 500 /etc/haproxy/errors/500.http
+        errorfile 502 /etc/haproxy/errors/502.http
+        errorfile 503 /etc/haproxy/errors/503.http
+        errorfile 504 /etc/haproxy/errors/504.http
+
+
+listen stats
+    bind :9188
+    mode http
+    stats enable
+    stats uri /
+    stats refresh 10s
+
+frontend my_ha_frontend
+    bind :88
+    default_backend my_ha_backend
+
+backend my_ha_backend
+    server Kryptograafia-1_agama_1 Kryptograafia-1:8001 check
+    server Kryptograafia-1_agama_2 Kryptograafia-1:8002 check
+    server Kryptograafia-2_agama_1 Kryptograafia-2:8001 check
+    server Kryptograafia-2_agama_2 Kryptograafia-2:8002 check

changed: [Kryptograafia-1]
--- before: /etc/haproxy/haproxy.cfg
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpx_x9efj7/haproxy.cfg.j2
@@ -1,34 +1,52 @@
 global
-	log /dev/log	local0
-	log /dev/log	local1 notice
-	chroot /var/lib/haproxy
-	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
-	stats timeout 30s
-	user haproxy
-	group haproxy
-	daemon
+        log /dev/log    local0
+        log /dev/log    local1 notice
+        chroot /var/lib/haproxy
+        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
+        stats timeout 30s
+        user haproxy
+        group haproxy
+        daemon
 
-	# Default SSL material locations
-	ca-base /etc/ssl/certs
-	crt-base /etc/ssl/private
+        # Default SSL material locations
+        #ca-base /etc/ssl/certs
+        #crt-base /etc/ssl/private
 
-	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
-        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
-        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
-        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
+        # See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
+        #ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
+        #ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
+        #ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
 
 defaults
-	log	global
-	mode	http
-	option	httplog
-	option	dontlognull
+        log     global
+        mode    http
+        option  httplog
+        option  dontlognull
         timeout connect 5000
         timeout client  50000
         timeout server  50000
-	errorfile 400 /etc/haproxy/errors/400.http
-	errorfile 403 /etc/haproxy/errors/403.http
-	errorfile 408 /etc/haproxy/errors/408.http
-	errorfile 500 /etc/haproxy/errors/500.http
-	errorfile 502 /etc/haproxy/errors/502.http
-	errorfile 503 /etc/haproxy/errors/503.http
-	errorfile 504 /etc/haproxy/errors/504.http
+        errorfile 400 /etc/haproxy/errors/400.http
+        errorfile 403 /etc/haproxy/errors/403.http
+        errorfile 408 /etc/haproxy/errors/408.http
+        errorfile 500 /etc/haproxy/errors/500.http
+        errorfile 502 /etc/haproxy/errors/502.http
+        errorfile 503 /etc/haproxy/errors/503.http
+        errorfile 504 /etc/haproxy/errors/504.http
+
+
+listen stats
+    bind :9188
+    mode http
+    stats enable
+    stats uri /
+    stats refresh 10s
+
+frontend my_ha_frontend
+    bind :88
+    default_backend my_ha_backend
+
+backend my_ha_backend
+    server Kryptograafia-1_agama_1 Kryptograafia-1:8001 check
+    server Kryptograafia-1_agama_2 Kryptograafia-1:8002 check
+    server Kryptograafia-2_agama_1 Kryptograafia-2:8001 check
+    server Kryptograafia-2_agama_2 Kryptograafia-2:8002 check

changed: [Kryptograafia-2]

TASK [haproxy : Ensure HAProxy is running and enabled] *************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Install the prometheus-haproxy-exporter package] ***************
The following NEW packages will be installed:
  prometheus-haproxy-exporter
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
The following NEW packages will be installed:
  prometheus-haproxy-exporter
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]

TASK [haproxy : Configure prometheus-haproxy-exporter scrape URI] **************
--- before: /etc/default/prometheus-haproxy-exporter (content)
+++ after: /etc/default/prometheus-haproxy-exporter (content)
@@ -2,7 +2,7 @@
 # Due to shell scaping, to pass backslashes for regexes, you need to double
 # them (\\d for \d). If running under systemd, you need to double them again
 # (\\\\d to mean \d), and escape newlines too.
-ARGS=""
+ARGS="--haproxy.scrape-uri=http://localhost:9188/stats;csv"
 
 # Prometheus-haproxy-exporter supports the following options:
 #

changed: [Kryptograafia-2]
--- before: /etc/default/prometheus-haproxy-exporter (content)
+++ after: /etc/default/prometheus-haproxy-exporter (content)
@@ -2,7 +2,7 @@
 # Due to shell scaping, to pass backslashes for regexes, you need to double
 # them (\\d for \d). If running under systemd, you need to double them again
 # (\\\\d to mean \d), and escape newlines too.
-ARGS=""
+ARGS="--haproxy.scrape-uri=http://localhost:9188/stats;csv"
 
 # Prometheus-haproxy-exporter supports the following options:
 #

changed: [Kryptograafia-1]

TASK [haproxy : Ensure prometheus-haproxy-exporter service is running] *********
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for lb-1 server] ***************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

RUNNING HANDLER [haproxy : Restart HAProxy service] ****************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

RUNNING HANDLER [haproxy : Restart prometheus-haproxy-exporter] ****************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

PLAY [keepalived_servers] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [keepalived : Install Keepalived] *****************************************
The following additional packages will be installed:
  ipvsadm libsensors-config libsensors5 libsnmp-base libsnmp40
Suggested packages:
  heartbeat ldirectord lm-sensors snmp-mibs-downloader
The following NEW packages will be installed:
  ipvsadm keepalived libsensors-config libsensors5 libsnmp-base libsnmp40
0 upgraded, 6 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  ipvsadm libsensors-config libsensors5 libsnmp-base libsnmp40
Suggested packages:
  heartbeat ldirectord lm-sensors snmp-mibs-downloader
The following NEW packages will be installed:
  ipvsadm keepalived libsensors-config libsensors5 libsnmp-base libsnmp40
0 upgraded, 6 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]

TASK [keepalived : Create keepalived_script user] ******************************
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [keepalived : Copy the Keepalived configuration] **************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [keepalived : Copy check_haproxy script] **********************************
--- before
+++ after: /home/ronk/ica0002/roles/keepalived/files/check_haproxy
@@ -0,0 +1,2 @@
+#!/bin/bash
+ss -ntl | grep -q ':88 '

changed: [Kryptograafia-2]
--- before
+++ after: /home/ronk/ica0002/roles/keepalived/files/check_haproxy
@@ -0,0 +1,2 @@
+#!/bin/bash
+ss -ntl | grep -q ':88 '

changed: [Kryptograafia-1]

TASK [keepalived : Ensure Keepalived is started and enabled] *******************
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [keepalived : Download keepalived-exporter package from Github] ***********
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [keepalived : Install Keepalived exporter] ********************************
Selecting previously unselected package keepalived-exporter.
(Reading database ... 65806 files and directories currently installed.)
Preparing to unpack .../keepalived-exporter_1.4.0_linux_amd64.deb ...
Unpacking keepalived-exporter (1.4.0) ...
Setting up keepalived-exporter (1.4.0) ...
changed: [Kryptograafia-2]
Selecting previously unselected package keepalived-exporter.
(Reading database ... 65806 files and directories currently installed.)
Preparing to unpack .../keepalived-exporter_1.4.0_linux_amd64.deb ...
Unpacking keepalived-exporter (1.4.0) ...
Setting up keepalived-exporter (1.4.0) ...
changed: [Kryptograafia-1]

TASK [keepalived : Create systemd service file for Keepalived Exporter] ********
--- before
+++ after: /etc/systemd/system/prometheus-keepalived-exporter.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Prometheus Keepalived exporter
+After=network.target
+
+[Service]
+ExecStart=/usr/bin/keepalived-exporter
+Restart=always
+User=root
+Group=root
+LimitNOFILE=4096
+
+[Install]
+WantedBy=multi-user.target

changed: [Kryptograafia-1]
--- before
+++ after: /etc/systemd/system/prometheus-keepalived-exporter.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Prometheus Keepalived exporter
+After=network.target
+
+[Service]
+ExecStart=/usr/bin/keepalived-exporter
+Restart=always
+User=root
+Group=root
+LimitNOFILE=4096
+
+[Install]
+WantedBy=multi-user.target

changed: [Kryptograafia-2]

TASK [keepalived : Reload systemd daemon to apply new service] *****************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Start Keepalived Exporter service] **************************
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for ka-1 server] ***************************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

RUNNING HANDLER [keepalived : Restart Keepalived service] **********************
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

RUNNING HANDLER [keepalived : Restart Prometheus Keepalived Exporter service] ***
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

RUNNING HANDLER [keepalived : Reload systemd daemon] ***************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

PLAY [IndluxDB servers] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [influxdb : Add InfluxData GPG key] ***************************************
changed: [Kryptograafia-3]

TASK [influxdb : Add InfluxDB repository] **************************************
--- before: /dev/null
+++ after: /etc/apt/sources.list.d/repos_influxdata_com_debian.list
@@ -0,0 +1 @@
+deb https://repos.influxdata.com/debian stable main

changed: [Kryptograafia-3]

TASK [influxdb : Install InfluxDB] *********************************************
The following NEW packages will be installed:
  influxdb
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-3]

TASK [influxdb : Copy influxdb.conf] *******************************************
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpa7paks7g/influxdb.conf.j2
@@ -0,0 +1,618 @@
+### Welcome to the InfluxDB configuration file.
+
+# The values in this file override the default values used by the system if
+# a config option is not specified. The commented out lines are the configuration
+# field and the default value used. Uncommenting a line and changing the value
+# will change the value used at runtime when the process is restarted.
+
+# Once every 24 hours InfluxDB will report usage data to usage.influxdata.com
+# The data includes a random ID, os, arch, version, the number of series and other
+# usage data. No data from user databases is ever transmitted.
+# Change this option to true to disable reporting.
+# reporting-disabled = false
+
+# Bind address to use for the RPC service for backup and restore.
+# bind-address = "127.0.0.1:8088"
+
+###
+### [meta]
+###
+### Controls the parameters for the Raft consensus group that stores metadata
+### about the InfluxDB cluster.
+###
+
+[meta]
+  # Where the metadata/raft database is stored
+  dir = "/var/lib/influxdb/meta"
+
+  # Automatically create a default retention policy when creating a database.
+  # retention-autocreate = true
+
+  # If log messages are printed for the meta service
+  # logging-enabled = true
+
+###
+### [data]
+###
+### Controls where the actual shard data for InfluxDB lives and how it is
+### flushed from the WAL. "dir" may need to be changed to a suitable place
+### for your system, but the WAL settings are an advanced configuration. The
+### defaults should work for most systems.
+###
+
+[data]
+  # The directory where the TSM storage engine stores TSM files.
+  dir = "/var/lib/influxdb/data"
+
+  # The directory where the TSM storage engine stores WAL files.
+  wal-dir = "/var/lib/influxdb/wal"
+  query-log-enabled = false
+  # The amount of time that a write will wait before fsyncing.  A duration
+  # greater than 0 can be used to batch up multiple fsync calls.  This is useful for slower
+  # disks or when WAL write contention is seen.  A value of 0s fsyncs every write to the WAL.
+  # Values in the range of 0-100ms are recommended for non-SSD disks.
+  # wal-fsync-delay = "0s"
+
+
+  # The type of shard index to use for new shards.  The default is an in-memory index that is
+  # recreated at startup.  A value of "tsi1" will use a disk based index that supports higher
+  # cardinality datasets.
+  # index-version = "inmem"
+
+  # Trace logging provides more verbose output around the tsm engine. Turning
+  # this on can provide more useful output for debugging tsm engine issues.
+  # trace-logging-enabled = false
+
+  # Whether queries should be logged before execution. Very useful for troubleshooting, but will
+  # log any sensitive data contained within a query.
+  # query-log-enabled = true
+
+  # It is possible to collect statistics of points written per-measurement and/or per-login.
+  # These can be accessed via the monitoring subsystem.
+  # ingress-metric-by-measurement-enabled = false
+  # ingress-metric-by-login-enabled = false
+
+
+  # Provides more error checking. For example, SELECT INTO will err out inserting an +/-Inf value
+  # rather than silently failing.
+  # strict-error-handling = false
+
+  # Validates incoming writes to ensure keys only have valid unicode characters.
+  # This setting will incur a small overhead because every key must be checked.
+  # validate-keys = false
+
+  # Settings for the TSM engine
+
+  # CacheMaxMemorySize is the maximum size a shard's cache can
+  # reach before it starts rejecting writes.
+  # Valid size suffixes are k, m, or g (case insensitive, 1024 = 1k).
+  # Values without a size suffix are in bytes.
+  # cache-max-memory-size = "1g"
+
+  # CacheSnapshotMemorySize is the size at which the engine will
+  # snapshot the cache and write it to a TSM file, freeing up memory
+  # Valid size suffixes are k, m, or g (case insensitive, 1024 = 1k).
+  # Values without a size suffix are in bytes.
+  # cache-snapshot-memory-size = "25m"
+
+  # CacheSnapshotWriteColdDuration is the length of time at
+  # which the engine will snapshot the cache and write it to
+  # a new TSM file if the shard hasn't received writes or deletes
+  # cache-snapshot-write-cold-duration = "10m"
+
+  # CompactFullWriteColdDuration is the duration at which the engine
+  # will compact all TSM files in a shard if it hasn't received a
+  # write or delete
+  # compact-full-write-cold-duration = "4h"
+
+  # The maximum number of concurrent full and level compactions that can run at one time.  A
+  # value of 0 results in 50% of runtime.GOMAXPROCS(0) used at runtime.  Any number greater
+  # than 0 limits compactions to that value.  This setting does not apply
+  # to cache snapshotting.
+  # max-concurrent-compactions = 0
+
+  # MaxConcurrentDeletes is the maximum number of simultaneous DELETE calls on a shard
+  # The default is 1, and should be left unchanged for most users
+  # MaxConcurrentDeletes = 1
+
+  # CompactThroughput is the rate limit in bytes per second that we
+  # will allow TSM compactions to write to disk. Note that short bursts are allowed
+  # to happen at a possibly larger value, set by CompactThroughputBurst
+  # compact-throughput = "48m"
+
+  # CompactThroughputBurst is the rate limit in bytes per second that we
+  # will allow TSM compactions to write to disk.
+  # compact-throughput-burst = "48m"
+
+  # If true, then the mmap advise value MADV_WILLNEED will be provided to the kernel with respect to
+  # TSM files. This setting has been found to be problematic on some kernels, and defaults to off.
+  # It might help users who have slow disks in some cases.
+  # tsm-use-madv-willneed = false
+
+  # Settings for the inmem index
+
+  # The maximum series allowed per database before writes are dropped.  This limit can prevent
+  # high cardinality issues at the database level.  This limit can be disabled by setting it to
+  # 0.
+  # max-series-per-database = 1000000
+
+  # The maximum number of tag values per tag that are allowed before writes are dropped.  This limit
+  # can prevent high cardinality tag values from being written to a measurement.  This limit can be
+  # disabled by setting it to 0.
+  # max-values-per-tag = 100000
+
+  # Settings for the tsi1 index
+
+  # The threshold, in bytes, when an index write-ahead log file will compact
+  # into an index file. Lower sizes will cause log files to be compacted more
+  # quickly and result in lower heap usage at the expense of write throughput.
+  # Higher sizes will be compacted less frequently, store more series in-memory,
+  # and provide higher write throughput.
+  # Valid size suffixes are k, m, or g (case insensitive, 1024 = 1k).
+  # Values without a size suffix are in bytes.
+  # max-index-log-file-size = "1m"
+
+  # The size of the internal cache used in the TSI index to store previously
+  # calculated series results. Cached results will be returned quickly from the cache rather
+  # than needing to be recalculated when a subsequent query with a matching tag key/value
+  # predicate is executed. Setting this value to 0 will disable the cache, which may
+  # lead to query performance issues.
+  # This value should only be increased if it is known that the set of regularly used
+  # tag key/value predicates across all measurements for a database is larger than 100. An
+  # increase in cache size may lead to an increase in heap usage.
+  series-id-set-cache-size = 100
+
+###
+### [coordinator]
+###
+### Controls the clustering service configuration.
+###
+
+[coordinator]
+  # The default time a write request will wait until a "timeout" error is returned to the caller.
+  # write-timeout = "10s"
+
+  # The maximum number of concurrent queries allowed to be executing at one time.  If a query is
+  # executed and exceeds this limit, an error is returned to the caller.  This limit can be disabled
+  # by setting it to 0.
+  # max-concurrent-queries = 0
+
+  # The maximum time a query will is allowed to execute before being killed by the system.  This limit
+  # can help prevent run away queries.  Setting the value to 0 disables the limit.
+  # query-timeout = "0s"
+
+  # The time threshold when a query will be logged as a slow query.  This limit can be set to help
+  # discover slow or resource intensive queries.  Setting the value to 0 disables the slow query logging.
+  # log-queries-after = "0s"
+
+  # Enables the logging of queries that are killed as a result of exceeding `query-timeout`
+  # log-timedout-queries = false
+
+  # The maximum number of points a SELECT can process.  A value of 0 will make
+  # the maximum point count unlimited.  This will only be checked every second so queries will not
+  # be aborted immediately when hitting the limit.
+  # max-select-point = 0
+
+  # The maximum number of series a SELECT can run.  A value of 0 will make the maximum series
+  # count unlimited.
+  # max-select-series = 0
+
+  # The maximum number of group by time bucket a SELECT can create.  A value of zero will max the maximum
+  # number of buckets unlimited.
+  # max-select-buckets = 0
+
+  # Whether to print a list of running queries when a data node receives a SIGTERM (sent when a process
+  # exceeds a container memory limit, or by the kill command.
+  # termination-query-log = false
+
+###
+### [retention]
+###
+### Controls the enforcement of retention policies for evicting old data.
+###
+
+[retention]
+  # Determines whether retention policy enforcement enabled.
+  # enabled = true
+
+  # The interval of time when retention policy enforcement checks run.
+  # check-interval = "30m"
+
+###
+### [shard-precreation]
+###
+### Controls the precreation of shards, so they are available before data arrives.
+### Only shards that, after creation, will have both a start- and end-time in the
+### future, will ever be created. Shards are never precreated that would be wholly
+### or partially in the past.
+
+[shard-precreation]
+  # Determines whether shard pre-creation service is enabled.
+  # enabled = true
+
+  # The interval of time when the check to pre-create new shards runs.
+  # check-interval = "10m"
+
+  # The default period ahead of the endtime of a shard group that its successor
+  # group is created.
+  # advance-period = "30m"
+
+###
+### Controls the system self-monitoring, statistics and diagnostics.
+###
+### The internal database for monitoring data is created automatically if
+### if it does not already exist. The target retention within this database
+### is called 'monitor' and is also created with a retention period of 7 days
+### and a replication factor of 1, if it does not exist. In all cases the
+### this retention policy is configured as the default for the database.
+
+[monitor]
+  # Whether to record statistics internally.
+  # store-enabled = true
+
+  # The destination database for recorded statistics
+  # store-database = "_internal"
+
+  # The interval at which to record statistics
+  # store-interval = "10s"
+
+###
+### [http]
+###
+### Controls how the HTTP endpoints are configured. These are the primary
+### mechanism for getting data into and out of InfluxDB.
+###
+
+[http]
+  # Determines whether HTTP endpoint is enabled.
+  # enabled = true
+  log-enabled = false
+  write-tracing = false
+  # Determines whether the Flux query endpoint is enabled.
+  # flux-enabled = false
+
+  # Determines whether the Flux query logging is enabled.
+  # flux-log-enabled = false
+
+  # The bind address used by the HTTP service.
+  # bind-address = ":8086"
+
+  # Determines whether user authentication is enabled over HTTP/HTTPS.
+  # auth-enabled = false
+
+  # The default realm sent back when issuing a basic auth challenge.
+  # realm = "InfluxDB"
+
+  # Determines whether HTTP request logging is enabled.
+  # log-enabled = true
+
+  # Determines whether the HTTP write request logs should be suppressed when the log is enabled.
+  # suppress-write-log = false
+
+  # When HTTP request logging is enabled, this option specifies the path where
+  # log entries should be written. If unspecified, the default is to write to stderr, which
+  # intermingles HTTP logs with internal InfluxDB logging.
+  #
+  # If influxd is unable to access the specified path, it will log an error and fall back to writing
+  # the request log to stderr.
+  # access-log-path = ""
+
+  # Filters which requests should be logged. Each filter is of the pattern NNN, NNX, or NXX where N is
+  # a number and X is a wildcard for any number. To filter all 5xx responses, use the string 5xx.
+  # If multiple filters are used, then only one has to match. The default is to have no filters which
+  # will cause every request to be printed.
+  # access-log-status-filters = []
+
+  # Determines whether detailed write logging is enabled.
+  # write-tracing = false
+
+  # Determines whether the pprof endpoint is enabled.  This endpoint is used for
+  # troubleshooting and monitoring.
+  # pprof-enabled = true
+
+  # Enables authentication on pprof endpoints. Users will need admin permissions
+  # to access the pprof endpoints when this setting is enabled. This setting has
+  # no effect if either auth-enabled or pprof-enabled are set to false.
+  # pprof-auth-enabled = false
+
+  # Enables a pprof endpoint that binds to localhost:6060 immediately on startup.
+  # This is only needed to debug startup issues.
+  # debug-pprof-enabled = false
+
+  # Enables authentication on the /ping, /metrics, and deprecated /status
+  # endpoints. This setting has no effect if auth-enabled is set to false.
+  # ping-auth-enabled = false
+
+  # Enables authentication on prometheus remote read api. This setting has no
+  # effect if auth-enabled is set to false.
+  # prom-read-auth-enabled = false
+
+  # Determines whether HTTPS is enabled.
+  # https-enabled = false
+
+  # The SSL certificate to use when HTTPS is enabled.
+  # https-certificate = "/etc/ssl/influxdb.pem"
+
+  # Use a separate private key location.
+  # https-private-key = ""
+
+  # The JWT auth shared secret to validate requests using JSON web tokens.
+  # shared-secret = ""
+
+  # The default chunk size for result sets that should be chunked.
+  # max-row-limit = 0
+
+  # The maximum number of HTTP connections that may be open at once.  New connections that
+  # would exceed this limit are dropped.  Setting this value to 0 disables the limit.
+  # max-connection-limit = 0
+
+  # Enable http service over unix domain socket
+  # unix-socket-enabled = false
+
+  # The path of the unix domain socket.
+  # bind-socket = "/var/run/influxdb.sock"
+
+  # The maximum size of a client request body, in bytes. Setting this value to 0 disables the limit.
+  # max-body-size = 25000000
+
+  # The maximum number of writes processed concurrently.
+  # Setting this to 0 disables the limit.
+  # max-concurrent-write-limit = 0
+
+  # The maximum number of writes queued for processing.
+  # Setting this to 0 disables the limit.
+  # max-enqueued-write-limit = 0
+
+  # The maximum duration for a write to wait in the queue to be processed.
+  # Setting this to 0 or setting max-concurrent-write-limit to 0 disables the limit.
+  # enqueued-write-timeout = 0
+
+        # User supplied HTTP response headers
+        #
+        # [http.headers]
+        #   X-Header-1 = "Header Value 1"
+        #   X-Header-2 = "Header Value 2"
+
+###
+### [logging]
+###
+### Controls how the logger emits logs to the output.
+###
+
+[logging]
+  # Determines which log encoder to use for logs. Available options
+  # are auto, logfmt, and json. auto will use a more user-friendly
+  # output format if the output terminal is a TTY, but the format is not as
+  # easily machine-readable. When the output is a non-TTY, auto will use
+  # logfmt.
+  # format = "auto"
+
+  # Determines which level of logs will be emitted. The available levels
+  # are error, warn, info, and debug. Logs that are equal to or above the
+  # specified level will be emitted.
+  # level = "info"
+
+  # Suppresses the logo output that is printed when the program is started.
+  # The logo is always suppressed if STDOUT is not a TTY.
+  # suppress-logo = false
+
+###
+### [subscriber]
+###
+### Controls the subscriptions, which can be used to fork a copy of all data
+### received by the InfluxDB host.
+###
+
+[subscriber]
+  # Determines whether the subscriber service is enabled.
+  # enabled = true
+
+  # The default timeout for HTTP writes to subscribers.
+  # http-timeout = "30s"
+
+  # Allows insecure HTTPS connections to subscribers.  This is useful when testing with self-
+  # signed certificates.
+  # insecure-skip-verify = false
+
+  # The path to the PEM encoded CA certs file. If the empty string, the default system certs will be used
+  # ca-certs = ""
+
+  # The number of writer goroutines processing the write channel.
+  # write-concurrency = 40
+
+  # The number of in-flight writes buffered in the write channel.
+  # write-buffer-size = 1000
+
+
+###
+### [[graphite]]
+###
+### Controls one or many listeners for Graphite data.
+###
+
+[[graphite]]
+  # Determines whether the graphite endpoint is enabled.
+  # enabled = false
+  # database = "graphite"
+  # retention-policy = ""
+  # bind-address = ":2003"
+  # protocol = "tcp"
+  # consistency-level = "one"
+
+  # These next lines control how batching works. You should have this enabled
+  # otherwise you could get dropped metrics or poor performance. Batching
+  # will buffer points in memory if you have many coming in.
+
+  # Flush if this many points get buffered
+  # batch-size = 5000
+
+  # number of batches that may be pending in memory
+  # batch-pending = 10
+
+  # Flush at least this often even if we haven't hit buffer limit
+  # batch-timeout = "1s"
+
+  # UDP Read buffer size, 0 means OS default. UDP listener will fail if set above OS max.
+  # udp-read-buffer = 0
+
+  ### This string joins multiple matching 'measurement' values providing more control over the final measurement name.
+  # separator = "."
+
+  ### Default tags that will be added to all metrics.  These can be overridden at the template level
+  ### or by tags extracted from metric
+  # tags = ["region=us-east", "zone=1c"]
+
+  ### Each template line requires a template pattern.  It can have an optional
+  ### filter before the template and separated by spaces.  It can also have optional extra
+  ### tags following the template.  Multiple tags should be separated by commas and no spaces
+  ### similar to the line protocol format.  There can be only one default template.
+  # templates = [
+  #   "*.app env.service.resource.measurement",
+  #   # Default template
+  #   "server.*",
+  # ]
+
+###
+### [collectd]
+###
+### Controls one or many listeners for collectd data.
+###
+
+[[collectd]]
+  # enabled = false
+  # bind-address = ":25826"
+  # database = "collectd"
+  # retention-policy = ""
+  #
+  # The collectd service supports either scanning a directory for multiple types
+  # db files, or specifying a single db file.
+  # typesdb = "/usr/local/share/collectd"
+  #
+  # security-level = "none"
+  # auth-file = "/etc/collectd/auth_file"
+
+  # These next lines control how batching works. You should have this enabled
+  # otherwise you could get dropped metrics or poor performance. Batching
+  # will buffer points in memory if you have many coming in.
+
+  # Flush if this many points get buffered
+  # batch-size = 5000
+
+  # Number of batches that may be pending in memory
+  # batch-pending = 10
+
+  # Flush at least this often even if we haven't hit buffer limit
+  # batch-timeout = "10s"
+
+  # UDP Read buffer size, 0 means OS default. UDP listener will fail if set above OS max.
+  # read-buffer = 0
+
+  # Multi-value plugins can be handled two ways.
+  # "split" will parse and store the multi-value plugin data into separate measurements
+  # "join" will parse and store the multi-value plugin as a single multi-value measurement.
+  # "split" is the default behavior for backward compatibility with previous versions of influxdb.
+  # parse-multivalue-plugin = "split"
+###
+### [opentsdb]
+###
+### Controls one or many listeners for OpenTSDB data.
+###
+
+[[opentsdb]]
+  # enabled = false
+  # bind-address = ":4242"
+  # database = "opentsdb"
+  # retention-policy = ""
+  # consistency-level = "one"
+  # tls-enabled = false
+  # certificate= "/etc/ssl/influxdb.pem"
+
+  # Log an error for every malformed point.
+  # log-point-errors = true
+
+  # These next lines control how batching works. You should have this enabled
+  # otherwise you could get dropped metrics or poor performance. Only points
+  # metrics received over the telnet protocol undergo batching.
+
+  # Flush if this many points get buffered
+  # batch-size = 1000
+
+  # Number of batches that may be pending in memory
+  # batch-pending = 5
+
+  # Flush at least this often even if we haven't hit buffer limit
+  # batch-timeout = "1s"
+
+###
+### [[udp]]
+###
+### Controls the listeners for InfluxDB line protocol data via UDP.
+###
+
+[[udp]]
+  # enabled = false
+  # bind-address = ":8089"
+  # database = "udp"
+  # retention-policy = ""
+
+  # InfluxDB precision for timestamps on received points ("" or "n", "u", "ms", "s", "m", "h")
+  # precision = ""
+
+  # These next lines control how batching works. You should have this enabled
+  # otherwise you could get dropped metrics or poor performance. Batching
+  # will buffer points in memory if you have many coming in.
+
+  # Flush if this many points get buffered
+  # batch-size = 5000
+
+  # Number of batches that may be pending in memory
+  # batch-pending = 10
+
+  # Will flush at least this often even if we haven't hit buffer limit
+  # batch-timeout = "1s"
+
+  # UDP Read buffer size, 0 means OS default. UDP listener will fail if set above OS max.
+  # read-buffer = 0
+
+###
+### [continuous_queries]
+###
+### Controls how continuous queries are run within InfluxDB.
+###
+
+[continuous_queries]
+  # Determines whether the continuous query service is enabled.
+  # enabled = true
+
+  # Controls whether queries are logged when executed by the CQ service.
+  # log-enabled = true
+
+  # Controls whether queries are logged to the self-monitoring data store.
+  # query-stats-enabled = false
+
+  # interval for how often continuous queries will be checked if they need to run
+  # run-interval = "1s"
+
+###
+### [tls]
+###
+### Global configuration settings for TLS in InfluxDB.
+###
+
+[tls]
+  # Determines the available set of cipher suites. See https://golang.org/pkg/crypto/tls/#pkg-constants
+  # for a list of available ciphers, which depends on the version of Go (use the query
+  # SHOW DIAGNOSTICS to see the version of Go used to build InfluxDB). If not specified, uses
+  # the default settings from Go's crypto/tls package.
+  # ciphers = [
+  #   "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305",
+  #   "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305",
+  # ]
+
+  # Minimum version of the tls protocol that will be negotiated. If not specified, uses the
+  # default settings from Go's crypto/tls package.
+  # min-version = "tls1.2"
+
+  # Maximum version of the tls protocol that will be negotiated. If not specified, uses the
+  # default settings from Go's crypto/tls package.
+  # max-version = "tls1.3"

changed: [Kryptograafia-3]

TASK [influxdb : Start and enable InfluxDB service] ****************************
changed: [Kryptograafia-3]

TASK [influxdb : Download InfluxDB stats exporter] *****************************
changed: [Kryptograafia-3]

TASK [influxdb : Set ownership for InfluxDB stats exporter binary] *************
--- before
+++ after
@@ -1,5 +1,5 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 121,
+    "owner": 113,
     "path": "/usr/local/bin/influxdb_stats_exporter"
 }

changed: [Kryptograafia-3]

TASK [influxdb : Create systemd service for InfluxDB stats exporter] ***********
--- before
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmp3mj0mxoj/prometheus-influxdb-stats-exporter.service.j2
@@ -0,0 +1,11 @@
+[Unit]
+Description=Prometheus InfluxDB Stats Exporter
+After=network.target
+
+[Service]
+User=prometheus
+ExecStart=/usr/local/bin/influxdb_stats_exporter
+Restart=always
+# --influxdb.url http://localhost/1:8086 --web.listen-address ":9424"
+[Install]
+WantedBy=multi-user.target

changed: [Kryptograafia-3]

TASK [influxdb : Enable and start InfluxDB stats exporter service] *************
changed: [Kryptograafia-3]

TASK [influxdb : Install Telegraf] *********************************************
The following NEW packages will be installed:
  telegraf
0 upgraded, 1 newly installed, 0 to remove and 120 not upgraded.
changed: [Kryptograafia-3]

TASK [influxdb : Copy Telegraf configuration] **********************************
diff skipped: destination file size is greater than 104448
changed: [Kryptograafia-3]

TASK [influxdb : Start and enable Telegraf service] ****************************
changed: [Kryptograafia-3]

TASK [influxdb : Ensure /home/backup/influxdb directory exists] ****************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/influxdb",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-3]

TASK [influxdb : Create cron job for InfluxDB backup] **************************
--- before: /etc/cron.d/influxdb-backup
+++ after: /etc/cron.d/influxdb-backup
@@ -0,0 +1,2 @@
+#Ansible: InfluxDB backup
+15 21 * * * backup rm -rf /home/backup/influxdb/*; influxd backup -portable -db telegraf /home/backup/influxdb

changed: [Kryptograafia-3]

TASK [influxdb : Add Duplicity full backup job] ********************************
--- before: /etc/cron.d/influxdb-backup (content)
+++ after: /etc/cron.d/influxdb-backup (content)
@@ -1,2 +1,3 @@
 #Ansible: InfluxDB backup
 15 21 * * * backup rm -rf /home/backup/influxdb/*; influxd backup -portable -db telegraf /home/backup/influxdb
+35 21 * * 0 backup duplicity --no-encryption full /home/backup/influxdb/ rsync://Kryptograafia@backup.kryptograafia.io/influxdb

changed: [Kryptograafia-3]

TASK [influxdb : Add Duplicity incremental backup job] *************************
--- before: /etc/cron.d/influxdb-backup (content)
+++ after: /etc/cron.d/influxdb-backup (content)
@@ -1,3 +1,4 @@
 #Ansible: InfluxDB backup
 15 21 * * * backup rm -rf /home/backup/influxdb/*; influxd backup -portable -db telegraf /home/backup/influxdb
 35 21 * * 0 backup duplicity --no-encryption full /home/backup/influxdb/ rsync://Kryptograafia@backup.kryptograafia.io/influxdb
+35 21 * * 1-6 backup duplicity --no-encryption incremental /home/backup/influxdb/ rsync://Kryptograafia@backup.kryptograafia.io/influxdb

changed: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for influxdb server] ***********************
changed: [Kryptograafia-3]

RUNNING HANDLER [influxdb : Restart InfluxDB] **********************************
changed: [Kryptograafia-3]

RUNNING HANDLER [influxdb : Reload systemd] ************************************
ok: [Kryptograafia-3]

RUNNING HANDLER [influxdb : Restart Telegraf] **********************************
changed: [Kryptograafia-3]

PLAY [Prometheus server] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [prometheus : Install Prometheus] *****************************************
The following additional packages will be installed:
  fonts-glyphicons-halflings libjs-bootstrap libjs-bootstrap4 libjs-d3
  libjs-eonasdan-bootstrap-datetimepicker libjs-jquery-hotkeys libjs-moment
  libjs-moment-timezone libjs-mustache libjs-popper.js libjs-rickshaw
  libjs-sizzle node-jquery
The following NEW packages will be installed:
  fonts-glyphicons-halflings libjs-bootstrap libjs-bootstrap4 libjs-d3
  libjs-eonasdan-bootstrap-datetimepicker libjs-jquery-hotkeys libjs-moment
  libjs-moment-timezone libjs-mustache libjs-popper.js libjs-rickshaw
  libjs-sizzle node-jquery prometheus
0 upgraded, 14 newly installed, 0 to remove and 120 not upgraded.
changed: [Kryptograafia-3]

TASK [prometheus : Include public http endpoint to ARGS parameter in /etc/default/prometheus] ***
--- before: /etc/default/prometheus (content)
+++ after: /etc/default/prometheus (content)
@@ -2,7 +2,7 @@
 # Due to shell escaping, to pass backslashes for regexes, you need to double
 # them (\\d for \d). If running under systemd, you need to double them again
 # (\\\\d to mean \d), and escape newlines too.
-ARGS=""
+ARGS="--web.external-url=http://193.40.156.67:12580/prometheus"
 
 # prometheus supports the following options:
 #

changed: [Kryptograafia-3]

TASK [prometheus : Modify the promehteus.yml file] *****************************
--- before: /etc/prometheus/prometheus.yml
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmplc4xjfq_/prometheus.yml.j2
@@ -1,39 +1,34 @@
 # Sample config for Prometheus.
 
 global:
-  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
+  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
   evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
   # scrape_timeout is set to the global default (10s).
 
-  # Attach these labels to any time series or alerts when communicating with
-  # external systems (federation, remote storage, Alertmanager).
+  # Attach these labels to any time series or alerts when communicating with this config.
   external_labels:
-      monitor: 'example'
+    monitor: 'example'
 
 # Alertmanager configuration
 alerting:
   alertmanagers:
-  - static_configs:
-    - targets: ['localhost:9093']
+    - static_configs:
+        - targets: ['localhost:9093']
 
 # Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
 rule_files:
   # - "first_rules.yml"
   # - "second_rules.yml"
 
-# A scrape configuration containing exactly one endpoint to scrape:
-# Here it's Prometheus itself.
+# Scrape configurations
 scrape_configs:
   # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
   - job_name: 'prometheus'
-
     # Override the global default and scrape targets from this job every 5 seconds.
     scrape_interval: 5s
     scrape_timeout: 5s
-
-    # metrics_path defaults to '/metrics'
+    metrics_path: '/prometheus/metrics'
     # scheme defaults to 'http'.
-
     static_configs:
       - targets: ['localhost:9090']
 
@@ -41,4 +36,60 @@
     # If prometheus-node-exporter is installed, grab stats about the local
     # machine by default.
     static_configs:
-      - targets: ['localhost:9100']
+      - targets:
+          - 'Kryptograafia-1:9100'
+          - 'Kryptograafia-2:9100'
+          - 'Kryptograafia-3:9100'
+
+  - job_name: 'linux'
+    static_configs:
+      - targets:
+          - 'localhost:9100'
+
+  - job_name: 'bind9'
+    static_configs:
+      - targets:
+        - 'ns-3:9119'
+        - 'ns-1:9119'
+        - 'ns-2:9119'
+    metrics_path: '/metrics'
+
+  - job_name: 'nginx'
+    static_configs:
+      - targets:
+        - 'nginx-1:9113'
+        - 'nginx-2:9113'
+        - 'nginx-3:9113'
+    metrics_path: '/metrics'
+
+  - job_name: 'mysql'
+    static_configs:
+      - targets:
+        - 'db-1:9104'
+        - 'db-2:9104'
+    metrics_path: '/metrics'
+
+  - job_name: 'influxdb'
+    static_configs:
+      - targets:
+          - 'influxdb:9424'
+    metrics_path: '/metrics'
+
+  - job_name: 'backups'
+    static_configs:
+      - targets: ['backup.kryptograafia.io:9111']
+    metrics_path: '/metrics'
+
+  - job_name: 'haproxy'
+    static_configs:
+      - targets:
+        - 'lb-1:9101'
+        - 'lb-2:9101'
+    metrics_path: '/metrics'
+
+  - job_name: 'keepalived'
+    static_configs:
+      - targets:
+        - 'ka-1:9165'
+        - 'ka-2:9165'
+    metrics_path: '/metrics'

changed: [Kryptograafia-3]

TASK [prometheus : Ensure Prometheus has started and is enabled] ***************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for prometheus server] *********************
changed: [Kryptograafia-3]

RUNNING HANDLER [prometheus : Restart prometheus if the configuration file is changed] ***
changed: [Kryptograafia-3]

PLAY [Grafana servers] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [grafana : Pull Grafana Docker image] *************************************
changed: [Kryptograafia-3]

TASK [grafana : Ensure Grafana directories exist] ******************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/grafana/provisioning/dashboards",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-3] => (item=dashboards)
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/grafana/provisioning/datasources",
-    "state": "absent"
+    "state": "directory"
 }

changed: [Kryptograafia-3] => (item=datasources)

TASK [grafana : Ensure Grafana template configuration files exist] *************
changed: [Kryptograafia-3] => (item=None)
changed: [Kryptograafia-3] => (item=None)
changed: [Kryptograafia-3] => (item=None)
changed: [Kryptograafia-3]

TASK [grafana : Ensure Grafana configuration files exist] **********************
--- before
+++ after: /home/ronk/ica0002/roles/grafana/files/backups.json
@@ -0,0 +1,329 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "grafana",
+          "uid": "-- Grafana --"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": 3,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          },
+          "unit": "s"
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 8,
+        "x": 0,
+        "y": 0
+      },
+      "id": 4,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "/^Time$/",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.3.0+security-01",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "time() - backup_last_success_time{user=\"Kryptograafia\", service=\"influxdb\"}",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Last InfluxDB backup",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 6,
+        "w": 8,
+        "x": 0,
+        "y": 5
+      },
+      "id": 3,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.3.0+security-01",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "backups_total{user=\"Kryptograafia\", service=\"influxdb\", type=\"full\"}",
+          "legendFormat": "{{service}},{{type}}",
+          "range": true,
+          "refId": "A"
+        },
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "ce21fsmtgpp8gc"
+          },
+          "editorMode": "code",
+          "expr": "backups_total{user=\"Kryptograafia\", service=\"influxdb\", type=\"incremental\"}",
+          "hide": false,
+          "instant": false,
+          "legendFormat": "{{service}},{{type}}",
+          "range": true,
+          "refId": "B"
+        }
+      ],
+      "title": "Number of full and incremental InfluxDB backups",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          },
+          "unit": "s"
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 6,
+        "w": 8,
+        "x": 0,
+        "y": 11
+      },
+      "id": 2,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "/^Time$/",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.3.0+security-01",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "backup_last_success_time{user=\"Kryptograafia\", service=\"mysql\"}",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Time since last MySQL backup",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 8,
+        "x": 0,
+        "y": 17
+      },
+      "id": 1,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.3.0+security-01",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "ce21fsmtgpp8gc"
+          },
+          "editorMode": "code",
+          "expr": "backups_total{user=\"Kryptograafia\", service=\"mysql\", type=\"full\"}",
+          "legendFormat": "{{service}}, {{type}}",
+          "range": true,
+          "refId": "A"
+        },
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "ce21fsmtgpp8gc"
+          },
+          "editorMode": "code",
+          "expr": "backups_total{user=\"Kryptograafia\", service=\"mysql\", type=\"incremental\"}\r\n",
+          "hide": false,
+          "instant": false,
+          "legendFormat": "{{service}}, {{type}}",
+          "range": true,
+          "refId": "B"
+        }
+      ],
+      "title": "Number of MySQL Full and Incremental Backups:",
+      "type": "stat"
+    }
+  ],
+  "preload": false,
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-6h",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "browser",
+  "title": "Backups",
+  "uid": "fe4cw2b4iud4wd",
+  "version": 7,
+  "weekStart": ""
+}

changed: [Kryptograafia-3] => (item={'src': 'backups.json', 'dest': '/opt/grafana/provisioning/dashboards/backups.json'})
--- before
+++ after: /home/ronk/ica0002/roles/grafana/files/main.json
@@ -0,0 +1,1414 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "grafana",
+          "uid": "-- Grafana --"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": 2,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 1,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 5,
+        "x": 0,
+        "y": 0
+      },
+      "id": 17,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "nginx_up",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "NGINX status",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 1,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 4,
+        "x": 5,
+        "y": 0
+      },
+      "id": 8,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "influxdb_exporter_stats_query_success",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "InfluxDB Health",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 1,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 7,
+        "x": 9,
+        "y": 0
+      },
+      "id": 11,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "haproxy_server_up",
+          "legendFormat": "{{server}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Container status",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 8,
+        "x": 16,
+        "y": 0
+      },
+      "id": 1,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "ce21fsmtgpp8gc"
+          },
+          "editorMode": "code",
+          "expr": "avg by(instance) (rate(node_cpu_seconds_total{mode!=\"idle\"}[1m])) * 100",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "CPU Utilization",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 1,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 4,
+        "x": 5,
+        "y": 4
+      },
+      "id": 14,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "keepalived_up",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Keepalived status",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 8,
+        "x": 16,
+        "y": 4
+      },
+      "id": 2,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "100 - (avg by(instance) (node_memory_MemAvailable_bytes) / avg by(instance) (node_memory_MemTotal_bytes) * 100)",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Memory Consumption",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 1,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 5,
+        "x": 0,
+        "y": 5
+      },
+      "id": 16,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "mysql_up",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL status",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 2,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "orange",
+                  "index": 1,
+                  "text": "Slave"
+                },
+                "2": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Master"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 5,
+        "x": 5,
+        "y": 8
+      },
+      "id": 13,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "keepalived_vrrp_state",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Keepalived role",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 1,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 6,
+        "x": 10,
+        "y": 8
+      },
+      "id": 12,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "bind_up",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Bind status",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "dark-red",
+                  "index": 1,
+                  "text": "Down"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "Up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 5,
+        "x": 0,
+        "y": 9
+      },
+      "id": 15,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "none",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "haproxy_up",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Haproxy status",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 8,
+        "x": 16,
+        "y": 9
+      },
+      "id": 9,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "influxdb_write_write_ok",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "InfluxDB write rate",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "PA29B73AE3477B0D6"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 6,
+        "w": 6,
+        "x": 0,
+        "y": 13
+      },
+      "id": 7,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PA29B73AE3477B0D6"
+          },
+          "query": "SELECT last(\"items\") FROM \"agama-stats\" WHERE \"name\" = 'Kryptograafia-1.kryptograafia.io.'",
+          "rawQuery": true,
+          "refId": "A",
+          "resultFormat": "time_series"
+        }
+      ],
+      "title": "Nr. of items in database of db-1(primary)",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 8,
+        "x": 16,
+        "y": 13
+      },
+      "id": 3,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "sum(rate(bind_resolver_queries_total{type=\"A\"}[1m]))",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Amount of A DNS Queries per Minute",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "PA29B73AE3477B0D6"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 8,
+        "x": 16,
+        "y": 17
+      },
+      "id": 6,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PA29B73AE3477B0D6"
+          },
+          "query": "SELECT \"items\" FROM \"agama-stats\"",
+          "rawQuery": true,
+          "refId": "A",
+          "resultFormat": "time_series"
+        }
+      ],
+      "title": "Item Counts Over Time for All Agamas",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": [
+          {
+            "__systemRef": "hideSeriesFrom",
+            "matcher": {
+              "id": "byNames",
+              "options": {
+                "mode": "exclude",
+                "names": [
+                  "Value"
+                ],
+                "prefix": "All except:",
+                "readOnly": true
+              }
+            },
+            "properties": [
+              {
+                "id": "custom.hideFrom",
+                "value": {
+                  "legend": false,
+                  "tooltip": false,
+                  "viz": true
+                }
+              }
+            ]
+          }
+        ]
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 8,
+        "x": 16,
+        "y": 21
+      },
+      "id": 5,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "sum(rate(nginx_http_requests_total[1m]))",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "NGINX Amount of http Requests per Minute",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green"
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 8,
+        "x": 16,
+        "y": 25
+      },
+      "id": 4,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "rate(mysql_global_status_commands_total{command=\"select\"}[1m])",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL Amount of Selects per Minute",
+      "type": "timeseries"
+    }
+  ],
+  "preload": false,
+  "refresh": "5s",
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-6h",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "browser",
+  "title": "Main dashboard",
+  "uid": "ae2219102qbr4c",
+  "version": 22,
+  "weekStart": ""
+}

changed: [Kryptograafia-3] => (item={'src': 'main.json', 'dest': '/opt/grafana/provisioning/dashboards/main.json'})
--- before
+++ after: /home/ronk/ica0002/roles/grafana/files/mysql.json
@@ -0,0 +1,394 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "grafana",
+          "uid": "-- Grafana --"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": 4,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 0
+      },
+      "id": 5,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.3.1",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "mysql_slave_status_slave_io_running",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        },
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "ce21fsmtgpp8gc"
+          },
+          "editorMode": "code",
+          "expr": "mysql_slave_status_slave_sql_running",
+          "hide": false,
+          "instant": false,
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "B"
+        }
+      ],
+      "title": "MySQL replication threads",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 8
+      },
+      "id": 4,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.3.1",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "mysql_global_variables_read_only",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL read only status",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 16
+      },
+      "id": 3,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.3.1",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "mysql_global_variables_server_id",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL server ID-s",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "ce21fsmtgpp8gc"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 24
+      },
+      "id": 2,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.3.1",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "rate(mysql_global_status_commands_total{command=\"select\"}[1m])",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL Status + Amount of Selects per Minute",
+      "type": "timeseries"
+    }
+  ],
+  "preload": false,
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-6h",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "browser",
+  "title": "MySQL",
+  "uid": "fe4t2zhmo6xogd",
+  "version": 9,
+  "weekStart": ""
+}

changed: [Kryptograafia-3] => (item={'src': 'mysql.json', 'dest': '/opt/grafana/provisioning/dashboards/mysql.json'})
--- before
+++ after: /home/ronk/ica0002/roles/grafana/files/syslog.json
@@ -0,0 +1,1124 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "datasource",
+          "uid": "grafana"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "description": "Telegraf / InfluxDB / Grafana as syslog receiver",
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": 2,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "PD48E60E9DE8E4DA7"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "Messages / min",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "bars",
+            "fillOpacity": 100,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "never",
+            "spanNulls": true,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "decimals": 0,
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          },
+          "unit": "none"
+        },
+        "overrides": [
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Info"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "rgb(80, 80, 80)",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Notice"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "rgb(182, 182, 182)",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Warning"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#E0B400",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Error"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#FF780A",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Critical"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#E02F44",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Alert"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#8F3BB8",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Emergency"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#8F3BB8",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          }
+        ]
+      },
+      "gridPos": {
+        "h": 7,
+        "w": 24,
+        "x": 0,
+        "y": 0
+      },
+      "id": 10,
+      "options": {
+        "alertThreshold": true,
+        "legend": {
+          "calcs": [
+            "mean",
+            "max",
+            "sum"
+          ],
+          "displayMode": "table",
+          "placement": "right",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "multi",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.3.0",
+      "targets": [
+        {
+          "alias": "Info",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "A",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "info"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Notice",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "B",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "notice"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Warning",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "D",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "warning"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Error",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "C",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "err"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Critical",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "E",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "crit"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Alert",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "F",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "alert"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Emergency",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "G",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "emerg"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        }
+      ],
+      "title": "syslog count",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "PD48E60E9DE8E4DA7"
+      },
+      "description": "",
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "custom": {
+            "align": "left",
+            "cellOptions": {
+              "type": "auto"
+            },
+            "filterable": false,
+            "inspect": false
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "dark-purple",
+                "value": null
+              },
+              {
+                "color": "dark-red",
+                "value": 2
+              },
+              {
+                "color": "dark-orange",
+                "value": 3
+              },
+              {
+                "color": "dark-yellow",
+                "value": 4
+              },
+              {
+                "color": "rgb(150, 150, 150)",
+                "value": 5
+              },
+              {
+                "color": "rgb(51, 51, 51)",
+                "value": 6
+              },
+              {
+                "color": "rgb(5, 5, 5)",
+                "value": 7
+              }
+            ]
+          }
+        },
+        "overrides": [
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "severity_code"
+            },
+            "properties": [
+              {
+                "id": "mappings",
+                "value": [
+                  {
+                    "options": {
+                      "0": {
+                        "text": "Emergency"
+                      },
+                      "1": {
+                        "text": "Alert"
+                      },
+                      "2": {
+                        "text": "Critical"
+                      },
+                      "3": {
+                        "text": "Error"
+                      },
+                      "4": {
+                        "text": "Warning"
+                      },
+                      "5": {
+                        "text": "Notice"
+                      },
+                      "6": {
+                        "text": "Info"
+                      },
+                      "7": {
+                        "text": "Debug"
+                      }
+                    },
+                    "type": "value"
+                  }
+                ]
+              },
+              {
+                "id": "custom.cellOptions",
+                "value": {
+                  "mode": "gradient",
+                  "type": "color-background"
+                }
+              },
+              {
+                "id": "custom.width",
+                "value": 119
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Time"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 163
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "hostname"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 194
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "appname"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 264
+              }
+            ]
+          }
+        ]
+      },
+      "gridPos": {
+        "h": 24,
+        "w": 24,
+        "x": 0,
+        "y": 7
+      },
+      "id": 12,
+      "options": {
+        "cellHeight": "sm",
+        "footer": {
+          "countRows": false,
+          "fields": "",
+          "reducer": [
+            "sum"
+          ],
+          "show": false
+        },
+        "showHeader": true,
+        "sortBy": [
+          {
+            "desc": true,
+            "displayName": "Time"
+          }
+        ]
+      },
+      "pluginVersion": "11.3.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PD48E60E9DE8E4DA7"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "hostname"
+              ],
+              "type": "tag"
+            },
+            {
+              "params": [
+                "appname"
+              ],
+              "type": "tag"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "A",
+          "resultFormat": "table",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              }
+            ],
+            [
+              {
+                "params": [
+                  "message"
+                ],
+                "type": "field"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        }
+      ],
+      "title": "Syslog Messages",
+      "type": "table"
+    }
+  ],
+  "preload": false,
+  "refresh": "5s",
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": [
+      {
+        "current": {
+          "text": [
+            "All"
+          ],
+          "value": [
+            "$__all"
+          ]
+        },
+        "datasource": "PD48E60E9DE8E4DA7",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=appname",
+        "includeAll": true,
+        "label": "Appname",
+        "multi": true,
+        "name": "appname",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=appname",
+        "refresh": 2,
+        "regex": "",
+        "sort": 1,
+        "type": "query"
+      },
+      {
+        "current": {
+          "text": [
+            "All"
+          ],
+          "value": [
+            "$__all"
+          ]
+        },
+        "datasource": "PD48E60E9DE8E4DA7",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=hostname",
+        "includeAll": true,
+        "label": "Hostname",
+        "multi": true,
+        "name": "hostname",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=hostname",
+        "refresh": 2,
+        "regex": "",
+        "sort": 1,
+        "type": "query"
+      },
+      {
+        "current": {
+          "text": [
+            "All"
+          ],
+          "value": [
+            "$__all"
+          ]
+        },
+        "datasource": "PD48E60E9DE8E4DA7",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=severity",
+        "includeAll": true,
+        "label": "Severity",
+        "multi": true,
+        "name": "severity",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=severity",
+        "refresh": 2,
+        "regex": "",
+        "type": "query"
+      },
+      {
+        "current": {
+          "text": "",
+          "value": ""
+        },
+        "description": "Querystring",
+        "label": "MessageQuery",
+        "name": "Query",
+        "options": [
+          {
+            "selected": true,
+            "text": "",
+            "value": ""
+          }
+        ],
+        "query": "",
+        "type": "textbox"
+      }
+    ]
+  },
+  "time": {
+    "from": "now-1h",
+    "to": "now"
+  },
+  "timepicker": {
+    "refresh_intervals": [
+      "5s",
+      " 10s",
+      " 30s",
+      " 1m",
+      " 5m"
+    ]
+  },
+  "timezone": "",
+  "title": "Syslog",
+  "uid": "TIYeHqRgZ",
+  "version": 1,
+  "weekStart": ""
+}

changed: [Kryptograafia-3] => (item={'src': 'syslog.json', 'dest': '/opt/grafana/provisioning/dashboards/syslog.json'})

TASK [grafana : Ensure Grafana container is running] ***************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "exists": false,
-    "running": false
+    "exists": true,
+    "running": true
 }

changed: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for grafana server] ************************
changed: [Kryptograafia-3]

RUNNING HANDLER [grafana : Restart Grafana Docker container] *******************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "restarted": false,
+    "restarted": true,
     "running": true
 }

changed: [Kryptograafia-3]

PLAY [Web server] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [nginx : Install Nginx web server] ****************************************
The following additional packages will be installed:
  libnginx-mod-http-geoip2 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream
  libnginx-mod-stream-geoip2 nginx-common nginx-core
Suggested packages:
  fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  libnginx-mod-http-geoip2 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream
  libnginx-mod-stream-geoip2 nginx nginx-common nginx-core
0 upgraded, 9 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]
The following additional packages will be installed:
  libnginx-mod-http-geoip2 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream
  libnginx-mod-stream-geoip2 nginx-common nginx-core
Suggested packages:
  fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  libnginx-mod-http-geoip2 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream
  libnginx-mod-stream-geoip2 nginx nginx-common nginx-core
0 upgraded, 9 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]
The following additional packages will be installed:
  libnginx-mod-http-geoip2 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream
  libnginx-mod-stream-geoip2 nginx-common nginx-core
Suggested packages:
  fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  libnginx-mod-http-geoip2 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream
  libnginx-mod-stream-geoip2 nginx nginx-common nginx-core
0 upgraded, 9 newly installed, 0 to remove and 120 not upgraded.
changed: [Kryptograafia-3]

TASK [nginx : Copy default file to managed host] *******************************
--- before: /etc/nginx/sites-enabled/default
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmpp8if86n6/default.j2
@@ -1,91 +1,23 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
+server {
+    listen 80 default_server;
+    server_name _;
 
-# Default server configuration
-#
-server {
-	listen 80 default_server;
-	listen [::]:80 default_server;
 
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
 
-	root /var/www/html;
+    location = /basic_status {
+        stub_status;
+    }
 
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
-
-	server_name _;
-
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
-	}
-
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
+    location / {
+        proxy_set_header Host $http_host;
+        proxy_pass http://www-1:8001;
+    }
 }
 
+server {
+    listen 8080 default_server;
 
-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}
+    location = /stub_status {
+        stub_status;
+    }
+}

changed: [Kryptograafia-1]
--- before: /etc/nginx/sites-enabled/default
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmphbj2mw4t/default.j2
@@ -1,91 +1,23 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
+server {
+    listen 80 default_server;
+    server_name _;
 
-# Default server configuration
-#
-server {
-	listen 80 default_server;
-	listen [::]:80 default_server;
 
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
 
-	root /var/www/html;
+    location = /basic_status {
+        stub_status;
+    }
 
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
-
-	server_name _;
-
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
-	}
-
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
+    location / {
+        proxy_set_header Host $http_host;
+        proxy_pass http://www-2:8001;
+    }
 }
 
+server {
+    listen 8080 default_server;
 
-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}
+    location = /stub_status {
+        stub_status;
+    }
+}

changed: [Kryptograafia-2]
--- before: /etc/nginx/sites-enabled/default
+++ after: /home/ronk/.ansible/tmp/ansible-local-3596q1v4cx50/tmp472b5f_p/default.j2
@@ -1,91 +1,26 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
+server {
+    listen 80 default_server;
+    server_name _;
 
-# Default server configuration
-#
-server {
-	listen 80 default_server;
-	listen [::]:80 default_server;
+    location /grafana {
+        proxy_pass http://localhost:3001;
+        proxy_set_header Host $http_host;
+    }
 
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
+    location /prometheus {
+        proxy_pass http://localhost:9090;
+    }
 
-	root /var/www/html;
+    location = /basic_status {
+        stub_status;
+    }
 
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
-
-	server_name _;
-
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
-	}
-
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
 }
 
+server {
+    listen 8080 default_server;
 
-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}
+    location = /stub_status {
+        stub_status;
+    }
+}

changed: [Kryptograafia-3]

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Flush handlers to restart Nginx now] *****************************

RUNNING HANDLER [nginx : Restart Nginx if configuration changes] ***************
changed: [Kryptograafia-3]
changed: [Kryptograafia-1]
changed: [Kryptograafia-2]

TASK [nginx : Install Nginx exporter] ******************************************
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-1]
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 120 not upgraded.
changed: [Kryptograafia-3]
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 119 not upgraded.
changed: [Kryptograafia-2]

TASK [nginx : Ensure Nginx service is started and enabled] *********************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [nginx : Ensure Nginx Exporter is started and enabled] ********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2, Kryptograafia-3

TASK [dns_record : Set CNAME record for nginx-1 server] ************************
changed: [Kryptograafia-3]
changed: [Kryptograafia-2]
changed: [Kryptograafia-1]

PLAY RECAP *********************************************************************
Kryptograafia-1            : ok=101  changed=72   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
Kryptograafia-2            : ok=101  changed=75   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
Kryptograafia-3            : ok=95   changed=75   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

+ ansible-playbook infra.yaml --diff
[WARNING]: Invalid characters were found in group names but not replaced, use
-vvvv to see details

PLAY [Initial setup] ***********************************************************

TASK [Gathering Facts] *********************************************************
[WARNING]: Platform linux on host Kryptograafia-2 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host Kryptograafia-3 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host Kryptograafia-1 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [init : Update APT cache] *************************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Install fping] ****************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [init : Ensure pip3 is installed] *****************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]

TASK [init : Ensure dnspython library is installed on the managed host] ********
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [init : Install Prometheus node exporter on all VM-s] *********************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]

TASK [init : Configure rsyslog.conf file] **************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [init : Configure rsyslog to send logs to Telegraf] ***********************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Ensure the backup user exists] ************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [init : Add backup server SSH key to known_hosts for user backup] *********
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [init : Ensure /home/backup/restore directory exists] *********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [init : Install Duplicity backup software] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

PLAY [Bind9 server] ************************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]

TASK [bind : Install Bind9 service] ********************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [bind : Copy the bind DNS named and local configuration to VM2] ***********
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3]
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-2]
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-1]

TASK [bind : Create master zone file and copy it to VM3] ***********************
skipping: [Kryptograafia-1]
skipping: [Kryptograafia-2]
ok: [Kryptograafia-3]

TASK [bind : Create reverse zone file and copy it to VM2] **********************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : Ensure Bind9 is started and enabled] ******************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [bind : Download Bind9 exporter] ******************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [bind : Install Bind9 exporter] *******************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : Copy the system definition to /etc/systemd/system/] ***************
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [bind : Start and enable Bind9 exporter service] **************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [bind : meta] *************************************************************

TASK [bind : meta] *************************************************************

TASK [bind : meta] *************************************************************

TASK [bind : Add A record for backup server] ***********************************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3, Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for ns-3 server] ***************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [bind : Stop and disable systemd-resolved service] ************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [bind : Update the resolv file] *******************************************
ok: [Kryptograafia-3 -> Kryptograafia-1(193.40.156.67)] => (item=Kryptograafia-1)
ok: [Kryptograafia-3 -> Kryptograafia-2(193.40.156.67)] => (item=Kryptograafia-2)
ok: [Kryptograafia-3] => (item=Kryptograafia-3)

PLAY [Database server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Install Python MySQL client] *************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Install MySQL server] ********************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Ensure MySQL is started and enabled] *****************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Copy the override.cnf file to managed host] **********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : MySQL database] **************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : MySQL user] ******************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Ensure MySQL is started and enabled] *****************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Create MySQL user for replication] *******************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Create user for MySQL exporter] **********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Copy my.cnf to remote host] **************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Ensure backup user] **********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure MySQL client configuration for backup user is set up] *****
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Create cron job for MySQL backup] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Add Duplicity full backup job] ***********************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Add Duplicity incremental backup job] ****************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Install the MySQL exporter] **************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure MySQL Exporter is started and enabled] ********************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Configure the replica server] ************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for db-1 server] ***************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

PLAY [Docker server] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [docker : Install Docker.io] **********************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [docker : Install Python Docker library] **********************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [docker : Ensure Docker daemon is running] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]

PLAY [Agama servers] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [agama : Register the number of all containers] ***************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [agama : Delete containers not in use] ************************************
skipping: [Kryptograafia-1] => (item=3) 
skipping: [Kryptograafia-1] => (item=4) 
skipping: [Kryptograafia-1]
skipping: [Kryptograafia-2] => (item=3) 
skipping: [Kryptograafia-2] => (item=4) 
skipping: [Kryptograafia-2]

TASK [agama : Create /opt/agama directory] *************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [agama : Download Agama and Dockerfile] ***********************************
ok: [Kryptograafia-1] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/agama.py)
ok: [Kryptograafia-2] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/agama.py)
ok: [Kryptograafia-1] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile)
ok: [Kryptograafia-2] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile)

TASK [agama : Build Agama Docker image] ****************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [agama : Run Agama containers] ********************************************
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-1]
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for www-1 server] **************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

PLAY [agama-client servers] ****************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [agama_client : Copy agama-client] ****************************************
ok: [Kryptograafia-3]

TASK [agama_client : Copy agama-client.service] ********************************
ok: [Kryptograafia-3]

TASK [agama_client : Create agama-client user] *********************************
ok: [Kryptograafia-3]

TASK [agama_client : Create directory for agama-client configuration] **********
ok: [Kryptograafia-3]

TASK [agama_client : Copy agama-client.conf] ***********************************
ok: [Kryptograafia-3]

TASK [agama_client : Ensure agama-client.service is started and enabled] *******
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for aclient server] ************************
ok: [Kryptograafia-3]

PLAY [HAProxy servers] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Install HAProxy] ***********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Configure HAProxy] *********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Ensure HAProxy is running and enabled] *************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Install the prometheus-haproxy-exporter package] ***************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Configure prometheus-haproxy-exporter scrape URI] **************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Ensure prometheus-haproxy-exporter service is running] *********
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for lb-1 server] ***************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

PLAY [keepalived_servers] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Install Keepalived] *****************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Create keepalived_script user] ******************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [keepalived : Copy the Keepalived configuration] **************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Copy check_haproxy script] **********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Ensure Keepalived is started and enabled] *******************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [keepalived : Download keepalived-exporter package from Github] ***********
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Install Keepalived exporter] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Create systemd service file for Keepalived Exporter] ********
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Reload systemd daemon to apply new service] *****************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [keepalived : Start Keepalived Exporter service] **************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for ka-1 server] ***************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

PLAY [IndluxDB servers] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [influxdb : Add InfluxData GPG key] ***************************************
ok: [Kryptograafia-3]

TASK [influxdb : Add InfluxDB repository] **************************************
ok: [Kryptograafia-3]

TASK [influxdb : Install InfluxDB] *********************************************
ok: [Kryptograafia-3]

TASK [influxdb : Copy influxdb.conf] *******************************************
ok: [Kryptograafia-3]

TASK [influxdb : Start and enable InfluxDB service] ****************************
ok: [Kryptograafia-3]

TASK [influxdb : Download InfluxDB stats exporter] *****************************
ok: [Kryptograafia-3]

TASK [influxdb : Set ownership for InfluxDB stats exporter binary] *************
ok: [Kryptograafia-3]

TASK [influxdb : Create systemd service for InfluxDB stats exporter] ***********
ok: [Kryptograafia-3]

TASK [influxdb : Enable and start InfluxDB stats exporter service] *************
ok: [Kryptograafia-3]

TASK [influxdb : Install Telegraf] *********************************************
ok: [Kryptograafia-3]

TASK [influxdb : Copy Telegraf configuration] **********************************
ok: [Kryptograafia-3]

TASK [influxdb : Start and enable Telegraf service] ****************************
ok: [Kryptograafia-3]

TASK [influxdb : Ensure /home/backup/influxdb directory exists] ****************
ok: [Kryptograafia-3]

TASK [influxdb : Create cron job for InfluxDB backup] **************************
ok: [Kryptograafia-3]

TASK [influxdb : Add Duplicity full backup job] ********************************
ok: [Kryptograafia-3]

TASK [influxdb : Add Duplicity incremental backup job] *************************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for influxdb server] ***********************
ok: [Kryptograafia-3]

PLAY [Prometheus server] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [prometheus : Install Prometheus] *****************************************
ok: [Kryptograafia-3]

TASK [prometheus : Include public http endpoint to ARGS parameter in /etc/default/prometheus] ***
ok: [Kryptograafia-3]

TASK [prometheus : Modify the promehteus.yml file] *****************************
ok: [Kryptograafia-3]

TASK [prometheus : Ensure Prometheus has started and is enabled] ***************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for prometheus server] *********************
ok: [Kryptograafia-3]

PLAY [Grafana servers] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [grafana : Pull Grafana Docker image] *************************************
ok: [Kryptograafia-3]

TASK [grafana : Ensure Grafana directories exist] ******************************
ok: [Kryptograafia-3] => (item=dashboards)
ok: [Kryptograafia-3] => (item=datasources)

TASK [grafana : Ensure Grafana template configuration files exist] *************
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3]

TASK [grafana : Ensure Grafana configuration files exist] **********************
ok: [Kryptograafia-3] => (item={'src': 'backups.json', 'dest': '/opt/grafana/provisioning/dashboards/backups.json'})
ok: [Kryptograafia-3] => (item={'src': 'main.json', 'dest': '/opt/grafana/provisioning/dashboards/main.json'})
ok: [Kryptograafia-3] => (item={'src': 'mysql.json', 'dest': '/opt/grafana/provisioning/dashboards/mysql.json'})
ok: [Kryptograafia-3] => (item={'src': 'syslog.json', 'dest': '/opt/grafana/provisioning/dashboards/syslog.json'})

TASK [grafana : Ensure Grafana container is running] ***************************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for grafana server] ************************
ok: [Kryptograafia-3]

PLAY [Web server] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [nginx : Install Nginx web server] ****************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [nginx : Copy default file to managed host] *******************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Install Nginx exporter] ******************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [nginx : Ensure Nginx service is started and enabled] *********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [nginx : Ensure Nginx Exporter is started and enabled] ********************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2, Kryptograafia-3

TASK [dns_record : Set CNAME record for nginx-1 server] ************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

PLAY RECAP *********************************************************************
Kryptograafia-1            : ok=88   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   
Kryptograafia-2            : ok=88   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   
Kryptograafia-3            : ok=82   changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

+ ansible all -b -m reboot -a test_command=uptime
[WARNING]: Invalid characters were found in group names but not replaced, use
-vvvv to see details
Kryptograafia-2 | CHANGED => {
    "changed": true,
    "elapsed": 42,
    "rebooted": true
}
Kryptograafia-1 | CHANGED => {
    "changed": true,
    "elapsed": 42,
    "rebooted": true
}
Kryptograafia-3 | CHANGED => {
    "changed": true,
    "elapsed": 43,
    "rebooted": true
}
+ sleep 15
+ ansible-playbook infra.yaml --diff
[WARNING]: Invalid characters were found in group names but not replaced, use
-vvvv to see details

PLAY [Initial setup] ***********************************************************

TASK [Gathering Facts] *********************************************************
[WARNING]: Platform linux on host Kryptograafia-3 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host Kryptograafia-1 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host Kryptograafia-2 is using the discovered
Python interpreter at /usr/bin/python3.10, but future installation of another
Python interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Update APT cache] *************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]

TASK [init : Install fping] ****************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [init : Ensure pip3 is installed] *****************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Ensure dnspython library is installed on the managed host] ********
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [init : Install Prometheus node exporter on all VM-s] *********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [init : Configure rsyslog.conf file] **************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Configure rsyslog to send logs to Telegraf] ***********************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Ensure the backup user exists] ************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Add backup server SSH key to known_hosts for user backup] *********
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [init : Ensure /home/backup/restore directory exists] *********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [init : Install Duplicity backup software] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

PLAY [Bind9 server] ************************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : Install Bind9 service] ********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [bind : Copy the bind DNS named and local configuration to VM2] ***********
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3]
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-1]
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-2]

TASK [bind : Create master zone file and copy it to VM3] ***********************
skipping: [Kryptograafia-1]
skipping: [Kryptograafia-2]
ok: [Kryptograafia-3]

TASK [bind : Create reverse zone file and copy it to VM2] **********************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : Ensure Bind9 is started and enabled] ******************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [bind : Download Bind9 exporter] ******************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : Install Bind9 exporter] *******************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [bind : Copy the system definition to /etc/systemd/system/] ***************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : Start and enable Bind9 exporter service] **************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [bind : meta] *************************************************************

TASK [bind : meta] *************************************************************

TASK [bind : meta] *************************************************************

TASK [bind : Add A record for backup server] ***********************************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3, Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for ns-3 server] ***************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [bind : Stop and disable systemd-resolved service] ************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

TASK [bind : Update the resolv file] *******************************************
ok: [Kryptograafia-3 -> Kryptograafia-1(193.40.156.67)] => (item=Kryptograafia-1)
ok: [Kryptograafia-3 -> Kryptograafia-2(193.40.156.67)] => (item=Kryptograafia-2)
ok: [Kryptograafia-3] => (item=Kryptograafia-3)

PLAY [Database server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Install Python MySQL client] *************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Install MySQL server] ********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure MySQL is started and enabled] *****************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Copy the override.cnf file to managed host] **********************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : MySQL database] **************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : MySQL user] ******************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure MySQL is started and enabled] *****************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Create MySQL user for replication] *******************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Create user for MySQL exporter] **********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Copy my.cnf to remote host] **************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure backup user] **********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure MySQL client configuration for backup user is set up] *****
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Create cron job for MySQL backup] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Add Duplicity full backup job] ***********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Add Duplicity incremental backup job] ****************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Install the MySQL exporter] **************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [mysql : Ensure MySQL Exporter is started and enabled] ********************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [mysql : Configure the replica server] ************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for db-1 server] ***************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

PLAY [Docker server] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [docker : Install Docker.io] **********************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [docker : Install Python Docker library] **********************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]

TASK [docker : Ensure Docker daemon is running] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

PLAY [Agama servers] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [agama : Register the number of all containers] ***************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [agama : Delete containers not in use] ************************************
skipping: [Kryptograafia-1] => (item=3) 
skipping: [Kryptograafia-1] => (item=4) 
skipping: [Kryptograafia-1]
skipping: [Kryptograafia-2] => (item=3) 
skipping: [Kryptograafia-2] => (item=4) 
skipping: [Kryptograafia-2]

TASK [agama : Create /opt/agama directory] *************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [agama : Download Agama and Dockerfile] ***********************************
ok: [Kryptograafia-2] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/agama.py)
ok: [Kryptograafia-1] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/agama.py)
ok: [Kryptograafia-1] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile)
ok: [Kryptograafia-2] => (item=https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile)

TASK [agama : Build Agama Docker image] ****************************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [agama : Run Agama containers] ********************************************
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-2] => (item=None)
ok: [Kryptograafia-2]
ok: [Kryptograafia-1] => (item=None)
ok: [Kryptograafia-1]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for www-1 server] **************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

PLAY [agama-client servers] ****************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [agama_client : Copy agama-client] ****************************************
ok: [Kryptograafia-3]

TASK [agama_client : Copy agama-client.service] ********************************
ok: [Kryptograafia-3]

TASK [agama_client : Create agama-client user] *********************************
ok: [Kryptograafia-3]

TASK [agama_client : Create directory for agama-client configuration] **********
ok: [Kryptograafia-3]

TASK [agama_client : Copy agama-client.conf] ***********************************
ok: [Kryptograafia-3]

TASK [agama_client : Ensure agama-client.service is started and enabled] *******
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for aclient server] ************************
ok: [Kryptograafia-3]

PLAY [HAProxy servers] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Install HAProxy] ***********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Configure HAProxy] *********************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Ensure HAProxy is running and enabled] *************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Install the prometheus-haproxy-exporter package] ***************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Configure prometheus-haproxy-exporter scrape URI] **************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [haproxy : Ensure prometheus-haproxy-exporter service is running] *********
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for lb-1 server] ***************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

PLAY [keepalived_servers] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Install Keepalived] *****************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Create keepalived_script user] ******************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Copy the Keepalived configuration] **************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Copy check_haproxy script] **********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Ensure Keepalived is started and enabled] *******************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Download keepalived-exporter package from Github] ***********
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Install Keepalived exporter] ********************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Create systemd service file for Keepalived Exporter] ********
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [keepalived : Reload systemd daemon to apply new service] *****************
ok: [Kryptograafia-2]
ok: [Kryptograafia-1]

TASK [keepalived : Start Keepalived Exporter service] **************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2

TASK [dns_record : Set CNAME record for ka-1 server] ***************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

PLAY [IndluxDB servers] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [influxdb : Add InfluxData GPG key] ***************************************
ok: [Kryptograafia-3]

TASK [influxdb : Add InfluxDB repository] **************************************
ok: [Kryptograafia-3]

TASK [influxdb : Install InfluxDB] *********************************************
ok: [Kryptograafia-3]

TASK [influxdb : Copy influxdb.conf] *******************************************
ok: [Kryptograafia-3]

TASK [influxdb : Start and enable InfluxDB service] ****************************
ok: [Kryptograafia-3]

TASK [influxdb : Download InfluxDB stats exporter] *****************************
ok: [Kryptograafia-3]

TASK [influxdb : Set ownership for InfluxDB stats exporter binary] *************
ok: [Kryptograafia-3]

TASK [influxdb : Create systemd service for InfluxDB stats exporter] ***********
ok: [Kryptograafia-3]

TASK [influxdb : Enable and start InfluxDB stats exporter service] *************
ok: [Kryptograafia-3]

TASK [influxdb : Install Telegraf] *********************************************
ok: [Kryptograafia-3]

TASK [influxdb : Copy Telegraf configuration] **********************************
ok: [Kryptograafia-3]

TASK [influxdb : Start and enable Telegraf service] ****************************
ok: [Kryptograafia-3]

TASK [influxdb : Ensure /home/backup/influxdb directory exists] ****************
ok: [Kryptograafia-3]

TASK [influxdb : Create cron job for InfluxDB backup] **************************
ok: [Kryptograafia-3]

TASK [influxdb : Add Duplicity full backup job] ********************************
ok: [Kryptograafia-3]

TASK [influxdb : Add Duplicity incremental backup job] *************************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for influxdb server] ***********************
ok: [Kryptograafia-3]

PLAY [Prometheus server] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [prometheus : Install Prometheus] *****************************************
ok: [Kryptograafia-3]

TASK [prometheus : Include public http endpoint to ARGS parameter in /etc/default/prometheus] ***
ok: [Kryptograafia-3]

TASK [prometheus : Modify the promehteus.yml file] *****************************
ok: [Kryptograafia-3]

TASK [prometheus : Ensure Prometheus has started and is enabled] ***************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for prometheus server] *********************
ok: [Kryptograafia-3]

PLAY [Grafana servers] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]

TASK [grafana : Pull Grafana Docker image] *************************************
ok: [Kryptograafia-3]

TASK [grafana : Ensure Grafana directories exist] ******************************
ok: [Kryptograafia-3] => (item=dashboards)
ok: [Kryptograafia-3] => (item=datasources)

TASK [grafana : Ensure Grafana template configuration files exist] *************
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3] => (item=None)
ok: [Kryptograafia-3]

TASK [grafana : Ensure Grafana configuration files exist] **********************
ok: [Kryptograafia-3] => (item={'src': 'backups.json', 'dest': '/opt/grafana/provisioning/dashboards/backups.json'})
ok: [Kryptograafia-3] => (item={'src': 'main.json', 'dest': '/opt/grafana/provisioning/dashboards/main.json'})
ok: [Kryptograafia-3] => (item={'src': 'mysql.json', 'dest': '/opt/grafana/provisioning/dashboards/mysql.json'})
ok: [Kryptograafia-3] => (item={'src': 'syslog.json', 'dest': '/opt/grafana/provisioning/dashboards/syslog.json'})

TASK [grafana : Ensure Grafana container is running] ***************************
ok: [Kryptograafia-3]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-3

TASK [dns_record : Set CNAME record for grafana server] ************************
ok: [Kryptograafia-3]

PLAY [Web server] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]
ok: [Kryptograafia-2]

TASK [nginx : Install Nginx web server] ****************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [nginx : Copy default file to managed host] *******************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Flush handlers to restart Nginx now] *****************************

TASK [nginx : Install Nginx exporter] ******************************************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [nginx : Ensure Nginx service is started and enabled] *********************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [nginx : Ensure Nginx Exporter is started and enabled] ********************
ok: [Kryptograafia-1]
ok: [Kryptograafia-3]
ok: [Kryptograafia-2]

TASK [include_role : dns_record] ***********************************************
included: dns_record for Kryptograafia-1, Kryptograafia-2, Kryptograafia-3

TASK [dns_record : Set CNAME record for nginx-1 server] ************************
ok: [Kryptograafia-2]
ok: [Kryptograafia-3]
ok: [Kryptograafia-1]

PLAY RECAP *********************************************************************
Kryptograafia-1            : ok=88   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   
Kryptograafia-2            : ok=88   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   
Kryptograafia-3            : ok=82   changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

+ date
Sun Dec 15 22:42:04 EET 2024
